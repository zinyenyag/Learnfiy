<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Learning Platform - Mathematics & More</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Arial', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        /* Screen reader only - accessible but visually hidden */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Header & Subjects */
        .header { text-align: center; padding: 40px 20px; color: white; }
        
        /* Hero Wrap with beautiful gradient */
        .hero-wrap {
            background: radial-gradient(1200px 600px at 20% 10%, rgba(34,197,94,0.18), transparent 55%),
                        radial-gradient(900px 500px at 85% 20%, rgba(167,139,250,0.25), transparent 55%),
                        linear-gradient(135deg, #3B0764 0%, #6D28D9 40%, #7C3AED 100%);
            border-radius: 22px;
            padding: 42px 26px;
            position: relative;
            overflow: hidden;
            margin: 20px auto;
            max-width: 1200px;
        }
        
        .hero-wrap::after {
            content: "";
            position: absolute;
            left: -10%;
            right: -10%;
            bottom: -60px;
            height: 180px;
            background: radial-gradient(120px 80px at 18% 40%, rgba(34,197,94,0.35), transparent 60%),
                        radial-gradient(160px 90px at 55% 30%, rgba(34,197,94,0.28), transparent 65%),
                        radial-gradient(160px 90px at 85% 45%, rgba(34,197,94,0.25), transparent 65%),
                        linear-gradient(180deg, rgba(34,197,94,0.0), rgba(34,197,94,0.16));
            filter: blur(0.2px);
            border-top-left-radius: 60% 100%;
            border-top-right-radius: 60% 100%;
        }
        
        .hero-wrap h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }
        
        .ai-motto {
            margin: 10px 0 18px;
            font-size: 1.05rem;
            line-height: 1.6;
            color: rgba(255,255,255,0.92);
            max-width: 640px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
            z-index: 1;
        }
        
        .ai-motto strong {
            color: #22C55E;
            font-weight: 600;
        }
        
        .subjects-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin: 40px 0 20px 0;
            position: relative;
            z-index: 1;
        }
        .subject-card { 
            background: white; 
            padding: 25px; 
            border-radius: 15px; 
            cursor: pointer; 
            transition: all 0.3s; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .subject-card:hover { 
            transform: translateY(-10px) scale(1.03); 
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.98);
        }
        .subject-card h3 { 
            color: #667eea; 
            margin-bottom: 10px; 
            font-size: 1.4rem;
            font-weight: 600;
        }
        .subject-card p {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        /* Main Sections */
        .main-content { 
            display: none !important; 
            background: white; 
            border-radius: 20px; 
            padding: 30px; 
            margin: 20px 0; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); 
        }
        .main-content.active,
        .main-content[style*="display: block"] {
            display: block !important;
        }
        .section-tabs { display: flex; gap: 10px; margin-bottom: 30px; }
        .tab-btn { 
            padding: 12px 25px; border: none; background: #f4f4f4; 
            border-radius: 25px; cursor: pointer; transition: all 0.3s;
        }
        .tab-btn.active { background: #667eea; color: white; }
        
        /* AI Tutor - Enhanced Design */
        .ai-tutor-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        .ai-tutor-header::before {
            content: "";
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .ai-tutor-header h2 {
            margin: 0;
            font-size: 28px;
            position: relative;
            z-index: 1;
        }
        
        .ai-tutor-subject-banner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .ai-chat { 
            height: 450px; 
            border: 3px solid #e0e7ff; 
            border-radius: 20px; 
            padding: 20px; 
            overflow-y: auto; 
            margin-bottom: 20px; 
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .message { 
            margin: 15px 0; 
            padding: 15px 18px; 
            border-radius: 15px; 
            max-width: 75%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .user-msg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            margin-left: auto;
            margin-right: 0;
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
        }
        
        .ai-msg { 
            background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%); 
            border: 2px solid #e0e7ff; 
            margin-right: auto;
            margin-left: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .chat-input { 
            display: flex; 
            gap: 10px; 
            align-items: center;
            background: white;
            padding: 12px;
            border-radius: 25px;
            border: 2px solid #e0e7ff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .chat-input input { 
            flex: 1; 
            padding: 12px 18px; 
            border: none; 
            border-radius: 20px; 
            font-size: 15px;
            outline: none;
            background: transparent;
        }
        
        .chat-input input:focus {
            background: #f8f9ff;
        }
        
        .file-attach-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(102,126,234,0.3);
            position: relative;
        }
        
        .file-attach-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(102,126,234,0.4);
        }
        
        .file-attach-btn:active {
            transform: scale(0.95);
        }
        
        .voice-record-btn {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(34,197,94,0.3);
        }
        
        .voice-record-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(34,197,94,0.4);
        }
        
        .voice-record-btn.recording {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: pulseRecording 1.5s ease-in-out infinite;
        }
        
        @keyframes pulseRecording {
            0%, 100% { transform: scale(1); box-shadow: 0 2px 6px rgba(239,68,68,0.3); }
            50% { transform: scale(1.05); box-shadow: 0 4px 12px rgba(239,68,68,0.5); }
        }
        
        /* Attachment Menu - Inline with small icons at bottom */
        .attachment-menu {
            display: none;
            position: absolute;
            bottom: 45px;
            left: 0;
            background: rgba(255, 255, 255, 0.98);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 6px 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            border: 1px solid rgba(0,0,0,0.1);
            animation: slideUp 0.2s ease;
            flex-direction: row;
            gap: 4px;
        }
        
        .attachment-menu.show {
            display: flex;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .attachment-menu-item {
            position: relative;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .attachment-menu-item:hover {
            background: rgba(102, 126, 234, 0.15);
            transform: scale(1.15);
        }
        
        .attachment-menu-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #667eea;
            position: relative;
        }
        
        /* Very small icon indicators - minimal design */
        .attachment-menu-icon.camera::before { 
            content: '‚óâ'; 
            font-size: 14px; 
            color: #667eea;
            line-height: 1;
        }
        .attachment-menu-icon.photos::before { 
            content: '‚óª'; 
            font-size: 14px; 
            color: #667eea;
            line-height: 1;
        }
        .attachment-menu-icon.document::before { 
            content: 'üìå'; 
            font-size: 11px; 
            line-height: 1;
        }
        .attachment-menu-icon.location::before { 
            content: '‚óè'; 
            font-size: 12px; 
            color: #667eea;
            line-height: 1;
        }
        .attachment-menu-icon.event::before { 
            content: '‚óê'; 
            font-size: 14px; 
            color: #667eea;
            line-height: 1;
        }
        
        /* Tooltip on hover */
        .attachment-menu-item::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: #333;
            color: white;
            padding: 5px 8px;
            border-radius: 5px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 1001;
            margin-bottom: 3px;
            font-weight: 500;
        }
        
        .attachment-menu-item::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(1px);
            border: 4px solid transparent;
            border-top-color: #333;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 1001;
        }
        
        .attachment-menu-item:hover::after,
        .attachment-menu-item:hover::before {
            opacity: 1;
        }
        
        /* Voice Recording UI */
        .voice-response-btn {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .voice-response-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }
        
        /* Attachment menu improvements */
        .attachment-menu {
            display: none;
            position: absolute;
            bottom: 60px;
            left: 10px;
            background: rgba(255, 255, 255, 0.98);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 320px;
            animation: slideUp 0.3s ease;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .attachment-menu-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 8px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform 0.2s ease;
        }
        
        .attachment-menu-item:hover .attachment-menu-icon {
            transform: scale(1.1) rotate(5deg);
        }
        .voice-recording {
            display: none;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            margin-bottom: 10px;
            color: white;
            align-items: center;
            gap: 15px;
        }
        
        .voice-recording.active {
            display: flex;
        }
        
        .voice-recording-visualizer {
            flex: 1;
            height: 30px;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .voice-bar {
            width: 4px;
            height: 25px;
            background: white;
            border-radius: 2px;
            transform-origin: bottom center;
            animation: voicePulse 0.5s ease infinite;
        }
        
        @keyframes voicePulse {
            0%, 100% { transform: scaleY(0.2); opacity: 0.5; }
            50% { transform: scaleY(1); opacity: 1; }
        }
        
        .voice-transcription {
            font-size: 14px;
            font-style: italic;
            margin-top: 5px;
            color: rgba(255,255,255,0.9);
        }
        
        .voice-stop-btn {
            background: white;
            color: #667eea;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Voice note playback */
        .voice-note-player {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f0f4ff;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .voice-play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .voice-note-duration {
            font-size: 14px;
            color: #666;
        }
        
        .chat-input button { 
            padding: 12px 30px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
        }
        
        .chat-input button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102,126,234,0.4);
        }
        
        .file-input-hidden {
            display: none;
        }
        
        .attached-file {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border: 2px solid #ff9800;
            border-radius: 20px;
            margin: 5px;
            font-size: 13px;
            color: #e65100;
            font-weight: 600;
        }
        
        .attached-file-remove {
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px;
            color: #d84315;
        }
        
        .attached-file-remove:hover {
            color: #bf360c;
        }
        
        /* Homework Upload - Enhanced with colors */
        .upload-area { 
            border: 2px dashed #ff6b35; 
            border-radius: 10px; 
            padding: 15px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s; 
            background: linear-gradient(135deg, #fff5f0 0%, #ffe5e0 100%);
            position: relative;
            min-height: auto;
        }
        .upload-area:hover { 
            background: linear-gradient(135deg, #ffe5e0 0%, #ffd4c4 100%);
            border-color: #ff4500;
            transform: scale(1.01);
        }
        .upload-area.dragover { 
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: #4caf50;
        }
        
        /* Homework Submissions Table */
        .homework-row {
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.2s ease;
        }
        
        .homework-row:hover {
            background: #f8f9ff;
        }
        
        .homework-row td {
            padding: 15px;
            vertical-align: middle;
        }
        
        .homework-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .homework-status.on-time {
            background: #dcfce7;
            color: #166534;
        }
        
        .homework-status.late {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .homework-mark {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        
        .homework-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }
        
        .homework-action-btn {
            background: transparent;
            border: 1px solid #667eea;
            color: #667eea;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .homework-action-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }
        
        .homework-action-btn.view {
            border-color: #2196f3;
            color: #2196f3;
        }
        
        .homework-action-btn.view:hover {
            background: #2196f3;
            color: white;
        }
        
        .homework-action-btn.download {
            border-color: #22c55e;
            color: #22c55e;
        }
        
        .homework-action-btn.download:hover {
            background: #22c55e;
            color: white;
        }
        
        .corrections-icon {
            color: #f59e0b;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s ease;
        }
        
        .corrections-icon:hover {
            transform: scale(1.2);
        }
        
        .corrections-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .corrections-modal.show {
            display: flex;
        }
        
        .corrections-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        #homework-result { 
            margin-top: 25px; 
            padding: 25px; 
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); 
            border-radius: 15px; 
            border-left: 6px solid #4caf50;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Academic Icons */
        .academic-icon {
            font-size: 2.5em;
            margin: 10px;
            display: inline-block;
            animation: float 3s ease-in-out infinite;
        }
        
        /* Smaller icons for AI Tutor header */
        .ai-tutor-header .academic-icon {
            font-size: 1.2em;
            margin: 0 5px;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        /* Colorful sections */
        .homework-section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .subject-banner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        
        .solution-box {
            margin: 15px 0;
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .solution-1 { background: #fff3e0; border-left-color: #ff9800; }
        .solution-2 { background: #e3f2fd; border-left-color: #2196f3; }
        .solution-3 { background: #f3e5f5; border-left-color: #9c27b0; }
        .solution-4 { background: #e8f5e9; border-left-color: #4caf50; }
        .solution-5 { background: #ffebee; border-left-color: #f44336; }
        
        /* Quiz - Enhanced Design */
        .quiz-wrap {
            max-width: 1100px;
            margin: 0 auto;
        }
        
        .quiz-hero {
            display: flex;
            gap: 16px;
            justify-content: space-between;
            align-items: stretch;
            padding: 20px 20px 16px;
            border-radius: 22px;
            background:
                radial-gradient(900px 420px at 15% 10%, rgba(34,197,94,0.18), transparent 60%),
                radial-gradient(900px 420px at 85% 10%, rgba(167,139,250,0.22), transparent 60%),
                linear-gradient(135deg, #3B0764 0%, #6D28D9 45%, #7C3AED 100%);
            color: #fff;
            position: relative;
            overflow: hidden;
            box-shadow: 0 18px 50px rgba(15, 23, 42, 0.25);
            margin-bottom: 16px;
        }
        
        .quiz-hero::after {
            content: "";
            position: absolute;
            left: -10%;
            right: -10%;
            bottom: -70px;
            height: 190px;
            background:
                radial-gradient(140px 90px at 18% 35%, rgba(34,197,94,0.35), transparent 65%),
                radial-gradient(180px 100px at 55% 25%, rgba(34,197,94,0.28), transparent 70%),
                radial-gradient(180px 100px at 85% 45%, rgba(34,197,94,0.25), transparent 70%),
                linear-gradient(180deg, rgba(34,197,94,0.0), rgba(34,197,94,0.14));
            border-top-left-radius: 60% 100%;
            border-top-right-radius: 60% 100%;
        }
        
        .quiz-hero-left, .quiz-hero-right {
            position: relative;
            z-index: 1;
        }
        
        .quiz-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            background: rgba(255,255,255,0.16);
            border: 1px solid rgba(255,255,255,0.22);
            font-weight: 600;
            width: fit-content;
            font-size: 0.9rem;
        }
        
        .quiz-title {
            margin: 10px 0 4px;
            font-size: 1.6rem;
            letter-spacing: -0.02em;
            font-weight: 700;
        }
        
        .quiz-motto {
            margin: 0;
            color: rgba(255,255,255,0.92);
            max-width: 560px;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        
        .quiz-hero-right {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }
        
        .quiz-stat {
            min-width: 140px;
            background: rgba(255,255,255,0.14);
            border: 1px solid rgba(255,255,255,0.18);
            border-radius: 16px;
            padding: 12px 14px;
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
        }
        
        .quiz-stat-label {
            font-size: 0.82rem;
            color: rgba(255,255,255,0.85);
        }
        
        .quiz-stat-value {
            font-size: 1.35rem;
            font-weight: 800;
            margin-top: 4px;
        }
        
        .quiz-card {
            background: rgba(255,255,255,0.95);
            border-radius: 22px;
            padding: 18px;
            box-shadow: 0 20px 60px rgba(2, 6, 23, 0.14);
        }
        
        .quiz-card-top {
            display: flex;
            gap: 12px;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .quiz-progress {
            flex: 1;
            height: 12px;
            background: #EEF2FF;
            border-radius: 999px;
            overflow: hidden;
            border: 1px solid rgba(109,40,217,0.16);
        }
        
        .quiz-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #22C55E, #6D28D9, #7C3AED);
            border-radius: 999px;
            transition: width .25s ease;
        }
        
        .quiz-question-meta {
            display: flex;
            gap: 10px;
            margin: 10px 0 10px;
        }
        
        .pill {
            display: inline-flex;
            padding: 6px 10px;
            border-radius: 999px;
            background: #F1F5F9;
            border: 1px solid rgba(15,23,42,0.08);
            font-weight: 600;
            font-size: 0.85rem;
            color: #0F172A;
        }
        
        .quiz-q-title {
            margin: 6px 0 12px;
            font-size: 1.15rem;
            color: #0F172A;
            font-weight: 600;
            line-height: 1.5;
        }
        
        .quiz-options {
            display: grid;
            gap: 10px;
            margin-bottom: 14px;
        }
        
        .option {
            padding: 12px 12px;
            border-radius: 14px;
            border: 1px solid rgba(15,23,42,0.10);
            background: #FFFFFF;
            cursor: pointer;
            transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
        }
        
        .option:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(2,6,23,0.10);
            border-color: rgba(109,40,217,0.25);
        }
        
        .option.selected {
            border-color: rgba(34,197,94,0.75);
            box-shadow: 0 10px 24px rgba(34,197,94,0.18);
            background: linear-gradient(180deg, rgba(34,197,94,0.08), rgba(109,40,217,0.04));
        }
        
        .quiz-nav {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 6px;
        }
        
        .btn {
            border: 0;
            padding: 10px 14px;
            border-radius: 999px;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .btn:disabled {
            opacity: .5;
            cursor: not-allowed;
        }
        
        .btn-purple {
            background: linear-gradient(90deg, #6D28D9, #7C3AED);
            color: #fff;
        }
        
        .btn-green {
            background: linear-gradient(90deg, #16A34A, #22C55E);
            color: #fff;
        }
        
        .btn-ghost {
            background: #F1F5F9;
            color: #0F172A;
            border: 1px solid rgba(15,23,42,0.10);
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .result-title {
            margin: 6px 0 10px;
            color: #0F172A;
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .result-score {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-radius: 18px;
            background: linear-gradient(135deg, rgba(34,197,94,0.10), rgba(109,40,217,0.06));
            border: 1px solid rgba(15,23,42,0.08);
        }
        
        .result-score-label {
            font-weight: 700;
            color: #0F172A;
        }
        
        .result-score-value {
            font-size: 1.6rem;
            font-weight: 900;
            color: #0F172A;
        }
        
        .result-subtext {
            margin: 10px 0 0;
            color: rgba(15,23,42,0.75);
            font-size: 0.95rem;
        }
        
        .result-actions {
            margin-top: 14px;
        }
        
        /* Old quiz styles - keeping for compatibility */
        .quiz-question { margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; }
        
        /* Analysis */
        .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .analysis-card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 15px; text-align: center; }
        
        /* Progress Subject Buttons */
        .subject-progress-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .subject-progress-btn:hover {
            background: #f0f0ff;
            transform: translateY(-2px);
        }
        .subject-progress-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* Progress */
        .progress-bar { background: #eee; height: 20px; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: #667eea; transition: width 0.5s; border-radius: 10px; }
        
        .section { display: none; }
        .section.active { display: block; }
        
        /* Ensure main-content is hidden initially */
        .main-content { display: none; }
        .main-content.active { display: block; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .section-tabs { flex-direction: column; }
            .subjects-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header & Subject Selection -->
        <div class="header" id="homePage">
            <section class="hero-wrap">
                <h1>üéì AI Learning Platform</h1>
                <p class="ai-motto">Learn <strong>smarter</strong>. Grow <strong>faster</strong>. Perform <strong>better</strong> ‚Äî powered by AI.</p>
                <div class="subjects-grid">
                    <div class="subject-card" data-subject="Mathematics">
                        <h3>üìê Mathematics</h3>
                        <p>Algebra, Calculus, Trigonometry, Geometry, Logarithms</p>
                    </div>
                    <div class="subject-card" data-subject="Accounting">
                        <h3>üí∞ Accounting</h3>
                        <p>Financial Accounting, Cost Accounting, Management Accounting, IAS Standards</p>
                    </div>
                    <div class="subject-card" data-subject="Economics">
                        <h3>üìà Economics</h3>
                        <p>Microeconomics, Macroeconomics, GDP, Inflation, Market Structures</p>
                    </div>
                    <div class="subject-card" data-subject="Computer Science">
                        <h3>üíª Computer Science</h3>
                        <p>Programming, Algorithms, Data Structures, OOP, Complexity Analysis</p>
                    </div>
                    <div class="subject-card" data-subject="Business Studies">
                        <h3>üè¢ Business Studies</h3>
                        <p>Management, Marketing, HR, Finance, Business Planning, Leadership</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Main Content Sections -->
        <div class="main-content" id="mainContent">
            <div class="section-tabs">
                <button class="tab-btn active" data-section="ai-tutor">ü§ñ AI Tutor</button>
                <button class="tab-btn" data-section="homework">üìù Homework</button>
                <button class="tab-btn" data-section="quiz">üìä Quiz</button>
                <button class="tab-btn" data-section="analysis">üìà Analysis</button>
                <button class="tab-btn" data-section="progress">üìã Progress</button>
            </div>

            <!-- AI Tutor Section -->
            <div id="ai-tutor" class="section active">
                <!-- Header with academic icons -->
                <div class="ai-tutor-header">
                    <h2 style="margin: 0; font-size: 24px;">
                        <span class="academic-icon">ü§ñ</span>
                        <span class="academic-icon">üí¨</span>
                        AI Tutor
                        <span class="academic-icon">üéì</span>
                        <span class="academic-icon">üìö</span>
                    </h2>
                    <p style="margin: 8px 0 0; font-size: 14px; opacity: 0.95; position: relative; z-index: 1;">
                        Learn smarter. Grow faster. Perform better ‚Äî powered by AI.
                    </p>
                </div>
                
                <!-- Subject Banner -->
                <div class="ai-tutor-subject-banner">
                    üìñ Current Subject: <span id="ai-tutor-subject-display">Please select a subject first</span>
                </div>
                
                <div class="ai-chat" id="chatMessages">
                    <!-- Welcome message removed - AI tutor agent will respond directly -->
                </div>
                
                <!-- File attachment display -->
                <div id="attachedFiles" style="margin-bottom: 10px; min-height: 30px;"></div>
                
                <!-- Voice Recording Display -->
                <div id="voiceRecordingDisplay" style="display: none; margin-bottom: 10px; padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #fff3e0 100%); border-radius: 15px; border-left: 4px solid #667eea;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">üé§ Recording...</div>
                            <div id="voiceTranscription" style="color: #333; font-size: 14px; min-height: 20px;">Listening...</div>
                            <div id="recordingTime" style="color: #666; font-size: 12px; margin-top: 5px;">00:00</div>
                        </div>
                        <button onclick="stopVoiceRecording()" style="background: #ff4444; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 18px;">‚èπÔ∏è</button>
                    </div>
                </div>
                
                <div class="chat-input" style="position: relative;">
                    <div style="position: relative; display: inline-block;">
                        <button class="file-attach-btn" onclick="toggleAttachmentMenu()" title="Attach file" aria-label="Attach file to message">
                            ‚ûï
                        </button>
                        <!-- Attachment Menu positioned relative to + button -->
                        <div id="attachmentMenu" class="attachment-menu">
                            <div class="attachment-menu-item" onclick="openCamera(); toggleAttachmentMenu();" data-tooltip="Camera">
                                <div class="attachment-menu-icon camera"></div>
                            </div>
                            <div class="attachment-menu-item" onclick="openPhotos(); toggleAttachmentMenu();" data-tooltip="Photos">
                                <div class="attachment-menu-icon photos"></div>
                            </div>
                            <div class="attachment-menu-item" onclick="document.getElementById('chatFileInput').click(); toggleAttachmentMenu();" data-tooltip="Document">
                                <div class="attachment-menu-icon document"></div>
                            </div>
                            <div class="attachment-menu-item" onclick="getLocation(); toggleAttachmentMenu();" data-tooltip="Location">
                                <div class="attachment-menu-icon location"></div>
                            </div>
                            <div class="attachment-menu-item" onclick="openEventPicker(); toggleAttachmentMenu();" data-tooltip="Event">
                                <div class="attachment-menu-icon event"></div>
                            </div>
                        </div>
                    </div>
                    <label for="chatFileInput" class="sr-only">Attach file to message</label>
                    <input type="file" id="chatFileInput" class="file-input-hidden" accept=".pdf,.doc,.docx,image/*,.txt,audio/*,video/*" multiple aria-label="Attach file to message" title="Attach file to message">
                    <label for="cameraInput" class="sr-only">Take photo or video</label>
                    <input type="file" id="cameraInput" accept="image/*,video/*" capture="environment" style="display: none;" aria-label="Take photo or video" title="Take photo or video">
                    <label for="photosInput" class="sr-only">Select photos or videos</label>
                    <input type="file" id="photosInput" accept="image/*,video/*" multiple style="display: none;" aria-label="Select photos or videos" title="Select photos or videos">
                    <label for="chatInput" class="sr-only">Type your question</label>
                    <input type="text" id="chatInput" placeholder="Type your question, use voice, or attach files..." aria-label="Type your question" title="Type your question">
                    <button id="voiceRecordBtn" class="voice-record-btn" onclick="startVoiceRecording()" title="Record voice message" aria-label="Record voice message">
                        üé§
                    </button>
                    <button onclick="sendMessage()" aria-label="Send message">Send</button>
                </div>
            </div>

            <!-- Homework Section -->
            <div id="homework" class="section">
                <!-- Header -->
                <div class="homework-section-header">
                    <h2 style="margin: 0; font-size: 24px;">
                        üìù Homework Submissions
                    </h2>
                </div>
                
                <!-- Subject Banner -->
                <div class="subject-banner">
                    üìñ Current Subject: <span id="current-subject-display">Please select a subject first</span>
                </div>
                
                <!-- File Upload Section for Submission -->
                <div style="margin-bottom: 15px; padding: 12px 15px; background: linear-gradient(135deg, #fff5f0 0%, #ffe5e0 100%); border-radius: 10px; border: 2px solid #ff6b35; box-shadow: 0 2px 8px rgba(255,107,53,0.15);">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #ff4500; font-size: 14px;">
                        üì§ Submit Your Homework
                    </label>
                    <p style="color: #666; font-size: 11px; margin-bottom: 10px; line-height: 1.3;">Upload your completed homework (PDF, Word, or Images). Images will be automatically compressed into one document.</p>
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('homeworkFile').click()" style="padding: 15px;">
                        <div style="font-size: 18px; margin-bottom: 4px; opacity: 0.7;">
                            üìé üì∑ üìÑ
                        </div>
                        <p style="font-size: 12px; color: #ff4500; font-weight: bold; margin: 4px 0;">Click to upload or drag & drop your file here</p>
                        <p style="font-size: 10px; color: #666;">Supported: PDF, Word, Images</p>
                        <label for="homeworkFile" class="sr-only">Upload homework file</label>
                        <input type="file" id="homeworkFile" accept=".pdf,.doc,.docx,image/*" multiple style="display: none;" aria-label="Upload homework file" title="Upload homework file">
                    </div>
                    <button id="submitHomeworkBtn" onclick="submitHomework()" style="margin-top: 8px; padding: 8px 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; cursor: pointer; font-size: 12px; font-weight: bold; box-shadow: 0 2px 8px rgba(102,126,234,0.3); transition: all 0.3s; display: none;" aria-label="Submit homework">
                        ‚úÖ Submit Homework
                    </button>
                </div>
                
                <!-- Loading indicator -->
                <div id="homework-loading" style="display: none; margin-top: 20px; padding: 25px; text-align: center; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 15px; border: 3px solid #2196f3;">
                    <div style="font-size: 28px; margin-bottom: 8px;">
                        ‚öôÔ∏è
                    </div>
                    <p style="font-size: 14px; color: #1976d2; font-weight: bold;">Uploading your homework...</p>
                    <p style="font-size: 12px; color: #666; margin-top: 6px;">Please wait while we process your submission...</p>
                </div>
                
                <!-- Homework Submissions Table -->
                <div style="margin-top: 15px;">
                    <h3 style="color: #667eea; font-size: 20px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        üìã Your Homework Submissions
                    </h3>
                    <div id="homeworkSubmissionsTable" style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-height: 400px; max-height: 70vh; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="position: sticky; top: 0; z-index: 10;">
                                <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <th style="padding: 12px 15px; text-align: left; font-weight: 600;">Homework</th>
                                    <th style="padding: 12px 15px; text-align: left; font-weight: 600;">Subject</th>
                                    <th style="padding: 12px 15px; text-align: left; font-weight: 600;">Submitted</th>
                                    <th style="padding: 12px 15px; text-align: center; font-weight: 600;">Status</th>
                                    <th style="padding: 12px 15px; text-align: center; font-weight: 600;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="homeworkSubmissionsBody">
                                <tr>
                                    <td colspan="5" style="padding: 40px; text-align: center; color: #999; font-style: italic;">
                                        No homework submissions yet. Upload your first homework above!
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Quiz Section -->
            <div id="quiz" class="section">
                <div class="quiz-wrap">
                    <div class="quiz-hero">
                        <div class="quiz-hero-left">
                            <div class="quiz-badge" id="quizSubjectBadge">Mathematics</div>
                            <h2 class="quiz-title" id="quizTitle">Quiz Challenge</h2>
                            <p class="quiz-motto">Learn smarter. Grow faster. Perform better ‚Äî powered by AI.</p>
                        </div>

                        <div class="quiz-hero-right">
                            <div class="quiz-stat">
                                <div class="quiz-stat-label">Questions</div>
                                <div class="quiz-stat-value" id="quizTotalCount">20</div>
                            </div>
                            <div class="quiz-stat">
                                <div class="quiz-stat-label">Progress</div>
                                <div class="quiz-stat-value" id="quizProgressText">0 / 20</div>
                            </div>
                        </div>
                    </div>

                    <div class="quiz-card">
                        <div class="quiz-card-top">
                            <div class="quiz-progress">
                                <div class="quiz-progress-bar" id="quizProgressBar" style="width: 0%;"></div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div id="quizSetNavigation" style="display: none; gap: 8px; align-items: center;">
                                    <button class="btn btn-ghost" id="btnPrevSet" onclick="prevSet()" style="padding: 6px 12px; font-size: 12px;" disabled>‚Üê Previous Set</button>
                                    <span id="setIndicator" style="font-weight: bold; color: #667eea; font-size: 14px;">Set 1</span>
                                    <button class="btn btn-ghost" id="btnNextSet" onclick="nextSet()" style="padding: 6px 12px; font-size: 12px;">Next Set ‚Üí</button>
                                </div>
                                <button class="btn btn-green" id="btnGenerateQuiz" onclick="generateQuiz()" aria-label="Generate new quiz">Generate New Quiz</button>
                            </div>
                        </div>

                        <div id="quizBody">
                            <div class="quiz-question-meta">
                                <span class="pill" id="quizDifficultyPill">Adaptive</span>
                                <span class="pill" id="quizTopicPill">Topic: Auto</span>
                            </div>

                            <h3 class="quiz-q-title" id="quizQuestionTitle">Click "Generate New Quiz" to start.</h3>

                            <div class="quiz-options" id="quizOptions"></div>

                            <div class="quiz-nav">
                                <button class="btn btn-ghost" id="btnPrev" onclick="prevQuestion()" disabled>Previous</button>
                                <button class="btn btn-purple" id="btnNext" onclick="nextQuestion()" disabled>Next</button>
                                <button class="btn btn-purple" id="btnFinish" onclick="finishQuiz()" style="display:none;" disabled>
                                    Finish Quiz
                                </button>
                            </div>
                        </div>

                        <div id="quizResult" style="display:none;">
                            <h3 class="result-title">Quiz Completed</h3>

                            <div class="result-score">
                                <div class="result-score-label">Total mark earned</div>
                                <div class="result-score-value" id="totalMarkEarned">0/20</div>
                            </div>

                            <div class="result-subtext" id="resultSubtext">
                                Review your weak areas and try again to improve.
                            </div>

                            <div class="result-actions">
                                <button class="btn btn-green" onclick="generateQuiz()" aria-label="Try another quiz">Try Another Quiz</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Section -->
            <div id="analysis" class="section">
                <div style="margin-bottom: 20px;">
                    <h2 style="color: #667eea; font-size: 24px; margin-bottom: 10px;">üìä Performance Analysis</h2>
                    <p style="color: #666; font-size: 14px;">Comprehensive analysis of your homework and quiz performance</p>
                </div>
                <div class="analysis-grid">
                    <div class="analysis-card" id="understandingLevelCard">
                        <h3>üìä Understanding Level</h3>
                        <div class="progress-bar"><div class="progress-fill" id="understandingProgress" style="width: 0%"></div></div>
                        <p id="understandingText">Calculating...</p>
                    </div>
                    <div class="analysis-card" id="weakAreasCard">
                        <h3>‚ö†Ô∏è Weak Areas</h3>
                        <div id="weakAreasContent">
                            <p style="font-style: italic; color: rgba(255,255,255,0.8);">Complete quizzes and homework to identify weak areas</p>
                        </div>
                    </div>
                    <div class="analysis-card" id="improvementCard">
                        <h3>üìà Improvement</h3>
                        <div id="improvementContent">
                            <p style="font-style: italic; color: rgba(255,255,255,0.8);">Track your progress over time</p>
                        </div>
                    </div>
                    <div class="analysis-card" id="timeSpentCard">
                        <h3>‚è±Ô∏è Time Spent</h3>
                        <div id="timeSpentContent">
                            <p>0h 0m this week</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Section -->
            <div id="progress" class="section">
                <div style="margin-bottom: 20px;">
                    <h2 style="color: #667eea; font-size: 24px; margin-bottom: 10px;" id="progressSubjectTitle">üìã Term Progress - <span id="progressSubjectName">Select a Subject</span></h2>
                    <p style="color: #666; font-size: 14px;" id="progressSubjectDescription">Select a subject from the homepage to view detailed progress tracking</p>
                </div>
                
                <!-- Subject Selection -->
                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="subject-progress-btn" onclick="switchProgressSubject('Mathematics')" data-subject="Mathematics">
                        üìê Mathematics
                    </button>
                    <button class="subject-progress-btn" onclick="switchProgressSubject('Accounting')" data-subject="Accounting">
                        üí∞ Accounting
                    </button>
                    <button class="subject-progress-btn" onclick="switchProgressSubject('Economics')" data-subject="Economics">
                        üìà Economics
                    </button>
                    <button class="subject-progress-btn" onclick="switchProgressSubject('Computer Science')" data-subject="Computer Science">
                        üíª Computer Science
                    </button>
                    <button class="subject-progress-btn" onclick="switchProgressSubject('Business Studies')" data-subject="Business Studies">
                        üè¢ Business Studies
                    </button>
                </div>
                
                <div class="analysis-grid">
                    <div class="analysis-card" id="homeworkProgressCard">
                        <h4>üìù Homeworks Submitted</h4>
                        <p id="homeworkProgressText">0/0</p>
                        <p id="homeworkProgressStatus" style="font-size: 12px; margin-top: 5px; opacity: 0.9;"></p>
                    </div>
                    <div class="analysis-card" id="quizAverageCard">
                        <h4>üìä Quiz Average</h4>
                        <p id="quizAverageText">0%</p>
                        <p id="quizAverageStatus" style="font-size: 12px; margin-top: 5px; opacity: 0.9;"></p>
                    </div>
                    <div class="analysis-card" id="questionsAskedCard">
                        <h4>‚ùì Questions Asked</h4>
                        <p id="questionsAskedText">0 follow-up questions</p>
                        <p id="questionsAskedStatus" style="font-size: 12px; margin-top: 5px; opacity: 0.9;"></p>
                    </div>
                    <div class="analysis-card" id="overallGradeCard">
                        <h4>‚≠ê Overall Grade</h4>
                        <p id="overallGradeText">N/A</p>
                        <p id="overallGradeStatus" style="font-size: 12px; margin-top: 5px; opacity: 0.9;"></p>
                    </div>
                </div>
                
                <!-- Homework Assignments Section -->
                <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìö Assigned Homeworks</h3>
                    <div id="homeworkAssignmentsList" style="max-height: 300px; overflow-y: auto;">
                        <p style="color: #666; font-style: italic;">No homework assignments yet. Complete quizzes and interact with AI Tutor to receive assignments.</p>
                    </div>
                    <button onclick="generateHomeworkAssignment()" style="margin-top: 15px; padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer;" aria-label="Get new homework assignment">
                        üéØ Get New Homework Assignment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSubject = '';
        let studentComments = [];
        let quizScore = 0;
        let answeredQuestions = new Set();
        
        // Performance tracking
        let sessionStartTime = Date.now();
        let currentSection = '';
        let sectionStartTime = Date.now();
        
        // Initialize tracking on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTracking);
        } else {
            // DOM already loaded
            initTracking();
        }
        
        // Initialize tracking system
        function initTracking() {
            if (!localStorage.getItem('studentPerformance')) {
                localStorage.setItem('studentPerformance', JSON.stringify({
                    quizzes: [],
                    homeworks: [],
                    homeworkAssignments: [],
                    homeworkSubmissions: [],
                    followUpQuestions: [],
                    timeSpent: {},
                    topicsMastered: {},
                    weakTopics: {},
                    weeklyHistory: []
                }));
            }
            updateAnalysis();
            // Initialize progress display with current subject or default
            updateProgressDisplay(currentSubject || 'Mathematics');
            startTimeTracking();
        }
        
        // Time tracking
        function startTimeTracking() {
            setInterval(() => {
                if (currentSection) {
                    const now = Date.now();
                    const timeSpent = Math.floor((now - sectionStartTime) / 1000); // seconds
                    saveTimeSpent(currentSection, timeSpent);
                    sectionStartTime = now;
                }
            }, 60000); // Update every minute
        }
        
        function saveTimeSpent(section, seconds) {
            const data = JSON.parse(localStorage.getItem('studentPerformance') || '{}');
            const weekStart = getWeekStart();
            if (!data.timeSpent) data.timeSpent = {};
            if (!data.timeSpent[weekStart]) data.timeSpent[weekStart] = {};
            if (!data.timeSpent[weekStart][section]) data.timeSpent[weekStart][section] = 0;
            data.timeSpent[weekStart][section] += seconds;
            localStorage.setItem('studentPerformance', JSON.stringify(data));
        }
        
        function getWeekStart() {
            const now = new Date();
            const day = now.getDay();
            const diff = now.getDate() - day; // Sunday = 0
            const weekStart = new Date(now.setDate(diff));
            weekStart.setHours(0, 0, 0, 0);
            return weekStart.toISOString().split('T')[0];
        }
        
        function getTotalTimeThisWeek() {
            const data = JSON.parse(localStorage.getItem('studentPerformance') || '{}');
            const weekStart = getWeekStart();
            const weeklyTime = data.timeSpent?.[weekStart] || {};
            let totalSeconds = 0;
            Object.values(weeklyTime).forEach(seconds => totalSeconds += seconds);
            return totalSeconds;
        }
        
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }
        
        // Track quiz results
        function saveQuizResult(subject, score, total, wrongAnswers, quizDate, setNumber = 1) {
            const data = JSON.parse(localStorage.getItem('studentPerformance') || '{}');
            if (!data.quizzes) data.quizzes = [];
            
            const quizResult = {
                subject: subject,
                score: score,
                total: total,
                percentage: (score / total) * 100,
                date: quizDate || new Date().toISOString(),
                wrongAnswers: wrongAnswers || [],
                setNumber: setNumber || 1
            };
            
            data.quizzes.push(quizResult);
            
            // Track weak topics from wrong answers
            if (!data.weakTopics) data.weakTopics = {};
            if (!data.weakTopics[subject]) data.weakTopics[subject] = {};
            
            wrongAnswers.forEach(wrong => {
                if (wrong.topic) {
                    if (!data.weakTopics[subject][wrong.topic]) {
                        data.weakTopics[subject][wrong.topic] = 0;
                    }
                    data.weakTopics[subject][wrong.topic]++;
                }
            });
            
            localStorage.setItem('studentPerformance', JSON.stringify(data));
            updateAnalysis();
        }
        
        // Track homework results and check for assignment matches
        function saveHomeworkResult(subject, questionText, success, feedback, date) {
            const data = JSON.parse(localStorage.getItem('studentPerformance') || '{}');
            if (!data.homeworks) data.homeworks = [];
            if (!data.homeworkAssignments) data.homeworkAssignments = [];
            if (!data.homeworkSubmissions) data.homeworkSubmissions = [];
            
            const homeworkResult = {
                subject: subject,
                question: questionText.substring(0, 100), // Store first 100 chars
                success: success, // true if solution was provided/generated
                feedback: feedback ? feedback.substring(0, 200) : '',
                date: date || new Date().toISOString(),
                isSubmission: false
            };
            
            // Check if this matches an assigned homework
            const assignments = data.homeworkAssignments.filter(a => a.subject === subject && !a.completed);
            let matchedAssignment = null;
            let daysLate = 0;
            
            for (const assignment of assignments) {
                // Simple matching: check if question text contains key terms from assignment
                const assignmentKeywords = extractKeywords(assignment.question || assignment.description);
                const questionKeywords = extractKeywords(questionText);
                const matchScore = calculateMatchScore(assignmentKeywords, questionKeywords);
                
                if (matchScore > 0.4) { // 40% keyword match threshold
                    matchedAssignment = assignment;
                    const assignmentDate = new Date(assignment.assignedDate);
                    const submissionDate = new Date(date || new Date());
                    const diffTime = submissionDate - assignmentDate;
                    daysLate = Math.floor(diffTime / (1000 * 60 * 60 * 24)) - 7; // Days after deadline
                    break;
                }
            }
            
            if (matchedAssignment) {
                // Mark assignment as completed
                matchedAssignment.completed = true;
                matchedAssignment.submittedDate = date || new Date().toISOString();
                matchedAssignment.daysLate = daysLate;
                
                // Save submission record
                data.homeworkSubmissions.push({
                    assignmentId: matchedAssignment.id,
                    subject: subject,
                    submittedDate: date || new Date().toISOString(),
                    daysLate: daysLate,
                    onTime: daysLate <= 0,
                    score: success ? 100 : 0 // Can be improved with actual grading
                });
            }
            
            data.homeworks.push(homeworkResult);
            localStorage.setItem('studentPerformance', JSON.stringify(data));
            updateAnalysis();
            if (document.getElementById('progress').classList.contains('active')) {
                updateProgressDisplay(currentProgressSubject || 'all');
            }
        }
        
        // Helper functions for homework matching
        function extractKeywords(text) {
            if (!text) return [];
            return text.toLowerCase()
                .replace(/[^\w\s]/g, ' ')
                .split(/\s+/)
                .filter(word => word.length > 3);
        }
        
        function calculateMatchScore(keywords1, keywords2) {
            if (keywords1.length === 0 || keywords2.length === 0) return 0;
            const set1 = new Set(keywords1);
            const set2 = new Set(keywords2);
            const intersection = [...set1].filter(x => set2.has(x));
            return intersection.length / Math.max(set1.size, set2.size);
        }
        
        // Generate homework assignment based on learning progress
        async function generateHomeworkAssignment() {
            if (!currentSubject) {
                alert('Please select a subject first to get homework assignments.');
                return;
            }
            
            const data = JSON.parse(localStorage.getItem('studentPerformance') || '{}');
            if (!data.homeworkAssignments) data.homeworkAssignments = [];
            
            // Get recent quiz performance to identify topics for homework
            const recentQuizzes = (data.quizzes || []).filter(q => q.subject === currentSubject).slice(-3);
            const weakTopics = [];
            
            recentQuizzes.forEach(quiz => {
                quiz.wrongAnswers?.forEach(wrong => {
                    const topic = wrong.topic || extractTopicFromQuestion(wrong.question);
                    if (topic && !weakTopics.includes(topic)) {
                        weakTopics.push(topic);
                    }
                });
            });
            
            // Subject-specific assignment topics
            const subjectTopics = {
                'Mathematics': [
                    'Solve quadratic equations',
                    'Work with simultaneous equations',
                    'Apply calculus concepts (derivatives and integrals)',
                    'Solve trigonometry problems',
                    'Practice algebra and factorization',
                    'Work with logarithms and exponentials',
                    'Geometry problems (areas, volumes, angles)',
                    'Statistics and probability problems'
                ],
                'Accounting': [
                    'Prepare a trial balance',
                    'Record double-entry transactions',
                    'Calculate depreciation',
                    'Prepare financial statements',
                    'Work with FIFO and LIFO inventory methods',
                    'Bank reconciliation problems',
                    'Cost accounting calculations',
                    'IAS standards application'
                ],
                'Economics': [
                    'Analyze supply and demand curves',
                    'Calculate GDP and economic indicators',
                    'Solve elasticity problems',
                    'Market structure analysis',
                    'Cost and revenue calculations',
                    'Inflation and unemployment analysis',
                    'International trade problems',
                    'Economic policy analysis'
                ],
                'Computer Science': [
                    'Write algorithms for given problems',
                    'Implement data structures',
                    'Solve programming problems',
                    'Analyze time complexity',
                    'Design database schemas',
                    'Network and security problems',
                    'Object-oriented programming tasks',
                    'Algorithm optimization'
                ],
                'Business Studies': [
                    'Complete SWOT analysis',
                    'Marketing mix strategy',
                    'Financial planning and budgeting',
                    'Human resource management case study',
                    'Business plan development',
                    'Leadership and management scenarios',
                    'Market segmentation analysis',
                    'Operations management problems'
                ]
            };
            
            const subject = currentSubject;
            const topics = subjectTopics[subject] || subjectTopics['Mathematics'];
            const topic = weakTopics.length > 0 
                ? `Practice ${weakTopics[0]} problems`
                : topics[Math.floor(Math.random() * topics.length)];
            
            // Generate Word document for homework
            try {
                const response = await fetch('http://localhost:5050/api/homework/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subject: subject,
                        weak_areas: weakTopics,
                        num_questions: Math.max(5, weakTopics.length * 2), // More questions for more weak areas
                        difficulty: 'medium'
                    })
                });
                
                if (response.ok) {
                    // Download the Word document
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const filename = `${subject}_Homework_${new Date().toISOString().split('T')[0]}.docx`;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    // Store assignment with document info
                    const assignment = {
                        id: Date.now().toString(),
                        subject: subject,
                        question: `Complete the following ${subject} homework assignment: ${topic}. Submit your solution through the Homework section.`,
                        description: topic,
                        assignedDate: new Date().toISOString(),
                        deadlineDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 days
                        completed: false,
                        topic: weakTopics[0] || topic,
                        documentUrl: filename, // Store filename for later access
                        weakAreas: weakTopics,
                        numQuestions: Math.max(5, weakTopics.length * 2)
                    };
                    
                    data.homeworkAssignments.push(assignment);
                    localStorage.setItem('studentPerformance', JSON.stringify(data));
                    
                    updateProgressDisplay(currentProgressSubject || 'all');
                    alert(`‚úÖ Homework assignment generated and downloaded!\n\nüìö Subject: ${subject}\nüìù Topic: ${topic}\nüìÖ Deadline: ${new Date(assignment.deadlineDate).toLocaleDateString()}\n\nüìÑ The Word document has been saved to your downloads. You can access it anytime!`);
                } else {
                    throw new Error('Failed to generate homework document');
                }
            } catch (error) {
                console.error('Error generating homework:', error);
                // Fallback: create assignment without document
                const assignment = {
                    id: Date.now().toString(),
                    subject: subject,
                    question: `Complete the following ${subject} homework assignment: ${topic}. Submit your solution through the Homework section.`,
                    description: topic,
                    assignedDate: new Date().toISOString(),
                    deadlineDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                    completed: false,
                    topic: weakTopics[0] || topic,
                    weakAreas: weakTopics
                };
                
                data.homeworkAssignments.push(assignment);
                localStorage.setItem('studentPerformance', JSON.stringify(data));
                
                updateProgressDisplay(currentProgressSubject || 'all');
                alert(`‚ö†Ô∏è Homework assigned (document generation unavailable)\n\nüìö Subject: ${subject}\nüìù Topic: ${topic}\nüìÖ Deadline: ${new Date(assignment.deadlineDate).toLocaleDateString()}\n\nPlease ensure the backend server is running for document generation.`);
            }
        }
        
        // Track follow-up questions (not initial questions)
        let lastAIResponse = '';
        let conversationContext = [];
        
        function trackFollowUpQuestion(userMessage, aiResponse) {
            // Check if this is a follow-up question (not initial)
            if (lastAIResponse && conversationContext.length > 0) {
                // Check for follow-up indicators
                const followUpKeywords = ['explain', 'more', 'detail', 'further', 'clarify', 'understand', 'how', 'why', 'what', 'elaborate', 'again', 'help', 'confused', 'don\'t understand', 'didn\'t get'];
                const userMsgLower = userMessage.toLowerCase();
                
                const isFollowUp = followUpKeywords.some(keyword => userMsgLower.includes(keyword)) ||
                                   userMsgLower.includes('?') && conversationContext.length > 1;
                
                if (isFollowUp) {
                    const data = JSON.parse(localStorage.getItem('studentPerformance') || '{}');
                    if (!data.followUpQuestions) data.followUpQuestions = [];
                    
                    data.followUpQuestions.push({
                        subject: currentSubject || 'Mathematics',
                        question: userMessage.substring(0, 200),
                        date: new Date().toISOString(),
                        context: conversationContext[conversationContext.length - 1].substring(0, 100) // Previous context
                    });
                    
                    localStorage.setItem('studentPerformance', JSON.stringify(data));
                    
                    if (document.getElementById('progress').classList.contains('active')) {
                        updateProgressDisplay(currentProgressSubject || 'all');
                    }
                }
            }
            
            // Update conversation context
            conversationContext.push(userMessage);
            if (conversationContext.length > 5) {
                conversationContext.shift(); // Keep only last 5 messages
            }
            lastAIResponse = aiResponse;
        }
        
        let currentProgressSubject = 'Mathematics'; // Default to Mathematics
        
        // Update Progress Display
        function updateProgressDisplay(subjectFilter) {
            // Only allow specific subjects, no 'all'
            if (!subjectFilter || subjectFilter === 'all') {
                subjectFilter = currentSubject || 'Mathematics';
            }
            
            currentProgressSubject = subjectFilter;
            
            // Update title and description
            const titleEl = document.getElementById('progressSubjectName');
            const descEl = document.getElementById('progressSubjectDescription');
            if (titleEl) {
                titleEl.textContent = subjectFilter;
            }
            if (descEl) {
                const subjectDescriptions = {
                    'Mathematics': 'Track your progress in algebra, calculus, trigonometry, and geometry',
                    'Accounting': 'Monitor your performance in financial accounting, cost accounting, and IAS standards',
                    'Economics': 'Review your progress in microeconomics, macroeconomics, and market analysis',
                    'Computer Science': 'Follow your journey in programming, algorithms, and data structures',
                    'Business Studies': 'Track your achievements in business management, marketing, and strategy'
                };
                descEl.textContent = subjectDescriptions[subjectFilter] || 'Comprehensive progress tracking for ' + subjectFilter;
            }
            
            // Update active button
            document.querySelectorAll('.subject-progress-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-subject') === subjectFilter);
            });
            
            const data = JSON.parse(localStorage.getItem('studentPerformance') || '{}');
            
            // 1. Homework Submitted
            updateHomeworkProgress(data, subjectFilter);
            
            // 2. Quiz Average (for this subject only)
            updateQuizAverage(data, subjectFilter);
            
            // 3. Questions Asked (follow-up questions only, for this subject)
            updateQuestionsAsked(data, subjectFilter);
            
            // 4. Overall Grade (for this subject only)
            updateOverallGrade(data, subjectFilter);
            
            // Update homework assignments list (for this subject only)
            updateHomeworkAssignmentsList(data, subjectFilter);
        }
        
        // Function to switch between subjects in progress view
        function switchProgressSubject(subject) {
            updateProgressDisplay(subject);
        }
        
        function updateHomeworkProgress(data, subjectFilter) {
            const assignments = data.homeworkAssignments || [];
            const submissions = data.homeworkSubmissions || [];
            
            // Always filter by subject (no 'all' option)
            const filteredAssignments = assignments.filter(a => a.subject === subjectFilter);
            const filteredSubmissions = submissions.filter(s => s.subject === subjectFilter);
            
            const total = filteredAssignments.length;
            const submitted = filteredAssignments.filter(a => a.completed).length;
            const late = filteredSubmissions.filter(s => s.daysLate > 0).length;
            
            const homeworkEl = document.getElementById('homeworkProgressText');
            const statusEl = document.getElementById('homeworkProgressStatus');
            
            if (homeworkEl) {
                homeworkEl.textContent = `${submitted}/${total}`;
            }
            
            if (statusEl) {
                if (total === 0) {
                    statusEl.textContent = 'Complete quizzes to get assignments';
                } else if (late > 0) {
                    statusEl.textContent = `‚ö†Ô∏è ${late} late submission(s)`;
                    statusEl.style.color = '#ff9800';
                } else if (submitted === total) {
                    statusEl.textContent = '‚úÖ All assignments completed on time!';
                    statusEl.style.color = '#4caf50';
                } else {
                    statusEl.textContent = `${total - submitted} pending assignment(s)`;
                    statusEl.style.color = 'rgba(255,255,255,0.9)';
                }
            }
        }
        
        function updateQuizAverage(data, subjectFilter) {
            // Always filter by subject (no 'all' option)
            const quizzes = (data.quizzes || []).filter(q => q.subject === subjectFilter);
            
            const averageEl = document.getElementById('quizAverageText');
            const statusEl = document.getElementById('quizAverageStatus');
            
            if (quizzes.length > 0) {
                const totalScore = quizzes.reduce((sum, q) => sum + q.percentage, 0);
                const avg = Math.round(totalScore / quizzes.length);
                
                if (averageEl) averageEl.textContent = `${avg}%`;
                if (statusEl) {
                    statusEl.textContent = `Based on ${quizzes.length} quiz(es) in ${subjectFilter}`;
                }
            } else {
                if (averageEl) averageEl.textContent = '0%';
                if (statusEl) statusEl.textContent = `Complete ${subjectFilter} quizzes to see average`;
            }
        }
        
        function updateQuestionsAsked(data, subjectFilter) {
            // Always filter by subject (no 'all' option)
            const questions = (data.followUpQuestions || []).filter(q => q.subject === subjectFilter);
            
            const questionsEl = document.getElementById('questionsAskedText');
            const statusEl = document.getElementById('questionsAskedStatus');
            
            if (questionsEl) {
                questionsEl.textContent = `${questions.length} follow-up question(s)`;
            }
            
            if (statusEl) {
                if (questions.length === 0) {
                    statusEl.textContent = 'Ask follow-up questions when you need clarification';
                } else {
                    const recentWeek = questions.filter(q => {
                        const qDate = new Date(q.date);
                        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                        return qDate >= weekAgo;
                    }).length;
                    statusEl.textContent = `${recentWeek} this week ‚Äî Good engagement! üí™`;
                }
            }
        }
        
        function updateOverallGrade(data, subjectFilter) {
            // Calculate grade from:
            // - Homework performance (40%)
            // - Quiz performance (40%)
            // - Question engagement (20% - showing active learning)
            
            // Always filter by subject (no 'all' option)
            const quizzes = (data.quizzes || []).filter(q => q.subject === subjectFilter);
            const submissions = (data.homeworkSubmissions || []).filter(s => s.subject === subjectFilter);
            const questions = (data.followUpQuestions || []).filter(q => q.subject === subjectFilter);
            
            // Quiz component (40%)
            let quizScore = 0;
            if (quizzes.length > 0) {
                quizScore = quizzes.reduce((sum, q) => sum + q.percentage, 0) / quizzes.length;
            }
            
            // Homework component (40%)
            let homeworkScore = 0;
            if (submissions.length > 0) {
                const avgScore = submissions.reduce((sum, s) => sum + (s.score || 0), 0) / submissions.length;
                const onTimeBonus = submissions.filter(s => s.onTime).length / submissions.length * 10; // 10% bonus
                homeworkScore = Math.min(100, avgScore + onTimeBonus);
            }
            
            // Question engagement (20%) - Active learners ask more questions
            let engagementScore = 0;
            if (quizzes.length > 0 || submissions.length > 0) {
                // Normalize: 0-5 questions = 0-50%, 5-15 = 50-80%, 15+ = 80-100%
                const questionCount = questions.length;
                if (questionCount >= 15) engagementScore = 100;
                else if (questionCount >= 5) engagementScore = 50 + ((questionCount - 5) / 10) * 30;
                else engagementScore = (questionCount / 5) * 50;
            }
            
            // Weighted average
            const overallScore = (quizScore * 0.4) + (homeworkScore * 0.4) + (engagementScore * 0.2);
            
            // Convert to letter grade
            let letterGrade = 'N/A';
            if (overallScore >= 90) letterGrade = 'A+';
            else if (overallScore >= 85) letterGrade = 'A';
            else if (overallScore >= 80) letterGrade = 'A-';
            else if (overallScore >= 75) letterGrade = 'B+';
            else if (overallScore >= 70) letterGrade = 'B';
            else if (overallScore >= 65) letterGrade = 'B-';
            else if (overallScore >= 60) letterGrade = 'C+';
            else if (overallScore >= 55) letterGrade = 'C';
            else if (overallScore >= 50) letterGrade = 'C-';
            else if (overallScore > 0) letterGrade = 'D';
            
            const gradeEl = document.getElementById('overallGradeText');
            const statusEl = document.getElementById('overallGradeStatus');
            
            if (gradeEl) {
                if (overallScore > 0) {
                    gradeEl.textContent = `${letterGrade} (${Math.round(overallScore)}%)`;
                } else {
                    gradeEl.textContent = 'N/A';
                }
            }
            
            if (statusEl) {
                if (overallScore > 0) {
                    statusEl.textContent = `Quiz: ${Math.round(quizScore)}% | Homework: ${Math.round(homeworkScore)}% | Engagement: ${Math.round(engagementScore)}%`;
                } else {
                    statusEl.textContent = 'Complete quizzes and homework to get a grade';
                }
            }
        }
        
        function updateHomeworkAssignmentsList(data, subjectFilter) {
            // Always filter by subject (no 'all' option)
            const assignments = data.homeworkAssignments || [];
            const filtered = assignments.filter(a => a.subject === subjectFilter);
            
            // Sort by date (newest first)
            filtered.sort((a, b) => new Date(b.assignedDate) - new Date(a.assignedDate));
            
            const listEl = document.getElementById('homeworkAssignmentsList');
            if (!listEl) return;
            
            if (filtered.length === 0) {
                listEl.innerHTML = '<p style="color: #666; font-style: italic;">No homework assignments yet. Complete quizzes and interact with AI Tutor to receive assignments.</p>';
                return;
            }
            
            let html = '';
            filtered.forEach(assignment => {
                const assignedDate = new Date(assignment.assignedDate);
                const deadlineDate = new Date(assignment.deadlineDate);
                const now = new Date();
                const isOverdue = !assignment.completed && now > deadlineDate;
                const daysUntilDeadline = Math.ceil((deadlineDate - now) / (1000 * 60 * 60 * 24));
                
                html += `
                    <div style="padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 2px solid ${assignment.completed ? '#4caf50' : isOverdue ? '#f44336' : '#667eea'}; background: ${assignment.completed ? '#e8f5e9' : isOverdue ? '#ffebee' : '#f3f4f6'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div>
                                <strong style="color: #333;">${assignment.subject}</strong>
                                ${assignment.completed ? '<span style="color: #4caf50; margin-left: 10px;">‚úÖ Completed</span>' : ''}
                                ${isOverdue ? '<span style="color: #f44336; margin-left: 10px;">‚ö†Ô∏è Overdue</span>' : ''}
                            </div>
                            <span style="font-size: 12px; color: #666;">${assignedDate.toLocaleDateString()}</span>
                        </div>
                        <p style="margin: 5px 0; color: #555;">${assignment.description || assignment.question}</p>
                        ${assignment.numQuestions ? `<p style="margin: 5px 0; color: #667eea; font-weight: 600;">üìù ${assignment.numQuestions} questions with allocated marks</p>` : ''}
                        ${assignment.weakAreas && assignment.weakAreas.length > 0 ? `<p style="margin: 5px 0; font-size: 12px; color: #666;">üéØ Focus areas: ${assignment.weakAreas.join(', ')}</p>` : ''}
                        <div style="font-size: 12px; color: #666; margin-top: 8px;">
                            üìÖ Deadline: ${deadlineDate.toLocaleDateString()}
                            ${!assignment.completed ? (isOverdue ? ` | ‚ö†Ô∏è ${Math.abs(daysUntilDeadline)} days overdue` : ` | ‚è∞ ${daysUntilDeadline} days remaining`) : ''}
                            ${assignment.daysLate > 0 ? ` | Submitted ${assignment.daysLate} days late` : assignment.completed && assignment.daysLate <= 0 ? ' | ‚úÖ Submitted on time' : ''}
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            ${assignment.documentUrl ? `
                                <button onclick="downloadHomework('${assignment.id}')" style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    üì• Download Word Document
                                </button>
                                <button onclick="viewHomework('${assignment.id}')" style="padding: 6px 12px; background: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    üëÅÔ∏è View Assignment
                                </button>
                            ` : `
                                <button onclick="regenerateHomeworkDocument('${assignment.id}')" style="padding: 6px 12px; background: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    üìÑ Generate Word Document
                                </button>
                            `}
                        </div>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }
        
        // Update Analysis section
        function updateAnalysis() {
            const data = JSON.parse(localStorage.getItem('studentPerformance') || '{}');
            
            // Calculate Understanding Level
            calculateUnderstandingLevel(data);
            
            // Identify Weak Areas
            identifyWeakAreas(data);
            
            // Calculate Improvement
            calculateImprovement(data);
            
            // Update Time Spent
            updateTimeSpent();
        }
        
        function calculateUnderstandingLevel(data) {
            const quizzes = data.quizzes || [];
            const homeworks = data.homeworks || [];
            
            let totalQuizScore = 0;
            let totalQuizMax = 0;
            let homeworkSuccessRate = 0;
            
            // Calculate quiz performance
            if (quizzes.length > 0) {
                quizzes.forEach(quiz => {
                    totalQuizScore += quiz.score;
                    totalQuizMax += quiz.total;
                });
            }
            
            // Calculate homework performance (last 10 homeworks)
            const recentHomeworks = homeworks.slice(-10);
            if (recentHomeworks.length > 0) {
                const successfulHomeworks = recentHomeworks.filter(h => h.success).length;
                homeworkSuccessRate = (successfulHomeworks / recentHomeworks.length) * 100;
            }
            
            // Weighted average: 60% quiz, 40% homework
            let understandingLevel = 0;
            if (totalQuizMax > 0) {
                const quizPercentage = (totalQuizScore / totalQuizMax) * 100;
                understandingLevel = (quizPercentage * 0.6) + (homeworkSuccessRate * 0.4);
            } else if (homeworks.length > 0) {
                understandingLevel = homeworkSuccessRate;
            }
            
            // Get comment based on level
            let comment = '';
            if (understandingLevel >= 80) {
                comment = 'Excellent ‚Äî Outstanding performance!';
            } else if (understandingLevel >= 60) {
                comment = 'Good ‚Äî Keep up the great work!';
            } else if (understandingLevel >= 40) {
                comment = 'Fair ‚Äî More practice will help improve.';
            } else if (understandingLevel > 0) {
                comment = 'Needs Improvement ‚Äî Focus on weak areas.';
            } else {
                comment = 'Complete quizzes and homework to see your level.';
            }
            
            // Update UI
            const progressEl = document.getElementById('understandingProgress');
            const textEl = document.getElementById('understandingText');
            if (progressEl) progressEl.style.width = Math.round(understandingLevel) + '%';
            if (textEl) {
                textEl.innerHTML = `${Math.round(understandingLevel)}% ‚Äî ${comment}`;
            }
        }
        
        function identifyWeakAreas(data) {
            const subject = currentSubject || 'Mathematics';
            const weakTopics = data.weakTopics?.[subject] || {};
            
            // Get wrong answers from recent quizzes
            const recentQuizzes = (data.quizzes || []).filter(q => q.subject === subject).slice(-5);
            const wrongAnswersByTopic = {};
            
            recentQuizzes.forEach(quiz => {
                quiz.wrongAnswers?.forEach(wrong => {
                    if (wrong.topic || wrong.question) {
                        const topic = wrong.topic || extractTopicFromQuestion(wrong.question);
                        if (topic) {
                            if (!wrongAnswersByTopic[topic]) wrongAnswersByTopic[topic] = 0;
                            wrongAnswersByTopic[topic]++;
                        }
                    }
                });
            });
            
            // Also check homework mistakes
            const recentHomeworks = (data.homeworks || []).filter(h => h.subject === subject && !h.success).slice(-5);
            
            // Combine weak topics
            const allWeakTopics = { ...weakTopics, ...wrongAnswersByTopic };
            const sortedWeakTopics = Object.entries(allWeakTopics)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([topic]) => topic);
            
            // Update UI
            const weakAreasEl = document.getElementById('weakAreasContent');
            if (weakAreasEl) {
                if (sortedWeakTopics.length > 0) {
                    weakAreasEl.innerHTML = sortedWeakTopics.map(topic => 
                        `<p style="margin: 5px 0;">‚Ä¢ ${topic}</p>`
                    ).join('');
                } else {
                    weakAreasEl.innerHTML = '<p style="font-style: italic; color: rgba(255,255,255,0.8);">No weak areas identified yet. Complete more quizzes to find areas to improve.</p>';
                }
            }
        }
        
        function extractTopicFromQuestion(question) {
            if (!question) return null;
            const q = question.toLowerCase();
            const topics = {
                'algebra': ['equation', 'solve', 'x +', 'quadratic', 'linear'],
                'geometry': ['angle', 'triangle', 'circle', 'area', 'perimeter', 'volume'],
                'calculus': ['derivative', 'integral', 'differentiate', 'integrate'],
                'trigonometry': ['sin', 'cos', 'tan', 'angle', 'triangle'],
                'logarithms': ['log', 'logarithm', 'exponent'],
                'statistics': ['mean', 'median', 'mode', 'standard deviation', 'probability']
            };
            
            for (const [topic, keywords] of Object.entries(topics)) {
                if (keywords.some(keyword => q.includes(keyword))) {
                    return topic;
                }
            }
            return null;
        }
        
        function calculateImprovement(data) {
            const subject = currentSubject || 'Mathematics';
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            // Get this week's quizzes
            const thisWeekQuizzes = (data.quizzes || []).filter(q => 
                q.subject === subject && new Date(q.date) >= weekAgo
            );
            
            // Get last week's quizzes
            const twoWeeksAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
            const lastWeekQuizzes = (data.quizzes || []).filter(q => 
                q.subject === subject && 
                new Date(q.date) >= twoWeeksAgo && 
                new Date(q.date) < weekAgo
            );
            
            // Calculate average scores
            const thisWeekAvg = thisWeekQuizzes.length > 0 
                ? thisWeekQuizzes.reduce((sum, q) => sum + q.percentage, 0) / thisWeekQuizzes.length
                : 0;
            
            const lastWeekAvg = lastWeekQuizzes.length > 0
                ? lastWeekQuizzes.reduce((sum, q) => sum + q.percentage, 0) / lastWeekQuizzes.length
                : 0;
            
            const improvement = thisWeekAvg - lastWeekAvg;
            
            // Count mastered topics (80%+ performance)
            const allQuizzes = (data.quizzes || []).filter(q => q.subject === subject);
            const topicPerformance = {};
            allQuizzes.forEach(quiz => {
                quiz.wrongAnswers?.forEach(wrong => {
                    const topic = wrong.topic || extractTopicFromQuestion(wrong.question);
                    if (topic) {
                        if (!topicPerformance[topic]) topicPerformance[topic] = { correct: 0, total: 0 };
                        topicPerformance[topic].total++;
                    }
                });
            });
            
            const masteredTopics = Object.entries(topicPerformance)
                .filter(([_, perf]) => perf.total >= 3 && (perf.correct / perf.total) >= 0.8)
                .map(([topic]) => topic);
            
            // Update UI
            const improvementEl = document.getElementById('improvementContent');
            if (improvementEl) {
                let html = '';
                if (improvement > 0) {
                    html += `<p style="margin: 5px 0; color: #4caf50;">+${Math.round(improvement)}% this week</p>`;
                } else if (improvement < 0) {
                    html += `<p style="margin: 5px 0; color: #ff9800;">${Math.round(improvement)}% this week</p>`;
                } else {
                    html += `<p style="margin: 5px 0;">No change this week</p>`;
                }
                if (masteredTopics.length > 0) {
                    html += `<p style="margin: 5px 0;">${masteredTopics.length} topic(s) mastered</p>`;
                    html += `<div style="margin-top: 10px; font-size: 12px;">${masteredTopics.slice(0, 3).join(', ')}</div>`;
                } else {
                    html += `<p style="margin: 5px 0; font-style: italic; font-size: 12px;">Complete more quizzes to master topics</p>`;
                }
                improvementEl.innerHTML = html;
            }
        }
        
        function updateTimeSpent() {
            const totalSeconds = getTotalTimeThisWeek();
            const timeSpentEl = document.getElementById('timeSpentContent');
            if (timeSpentEl) {
                timeSpentEl.innerHTML = `<p style="font-size: 18px; font-weight: bold; margin: 5px 0;">${formatTime(totalSeconds)} this week</p>`;
                
                // Add commitment level
                let commitmentLevel = '';
                if (totalSeconds >= 3600 * 5) { // 5+ hours
                    commitmentLevel = 'Excellent commitment! üåü';
                } else if (totalSeconds >= 3600 * 3) { // 3+ hours
                    commitmentLevel = 'Good dedication! üëç';
                } else if (totalSeconds >= 3600) { // 1+ hour
                    commitmentLevel = 'Keep it up! üí™';
                } else {
                    commitmentLevel = 'Start studying to track progress';
                }
                timeSpentEl.innerHTML += `<p style="font-size: 14px; margin-top: 5px; opacity: 0.9;">${commitmentLevel}</p>`;
            }
        }
        
        // Syllabus-aligned quiz questions by subject
        const subjectQuizQuestions = {
            'Mathematics': [
                { q: "Solve: 2x + 3y = 7, x - y = 1", options: ["x=2, y=1", "x=1, y=2", "x=3, y=1", "x=4, y=0"], correct: 0 },
                { q: "What is the quadratic formula?", options: ["x = (-b ¬± ‚àö(b¬≤-4ac))/2a", "x = b¬≤-4ac", "x = -b/2a", "x = a+b+c"], correct: 0 },
                { q: "Factor: x¬≤ + 5x + 6", options: ["(x+2)(x+3)", "(x+1)(x+6)", "(x+5)(x+1)", "Cannot factor"], correct: 0 },
                { q: "What is the derivative of x¬≤?", options: ["2x", "x", "2x¬≤", "x¬≤/2"], correct: 0 },
                { q: "If log‚ÇÅ‚ÇÄ(x) = 2, what is x?", options: ["100", "10", "20", "2"], correct: 0 },
                { q: "What is sin(90¬∞)?", options: ["1", "0", "0.5", "‚àö2/2"], correct: 0 },
                { q: "Solve: 3x - 7 = 2x + 5", options: ["x = 12", "x = 2", "x = -2", "x = 7"], correct: 0 },
                { q: "What is the area of a circle with radius r?", options: ["œÄr¬≤", "2œÄr", "œÄr", "r¬≤"], correct: 0 },
                { q: "What is the value of cos(0¬∞)?", options: ["1", "0", "0.5", "‚àö3/2"], correct: 0 },
                { q: "Simplify: (a+b)¬≤", options: ["a¬≤ + 2ab + b¬≤", "a¬≤ + b¬≤", "a¬≤ - 2ab + b¬≤", "2a + 2b"], correct: 0 },
                { q: "What is the slope of the line y = 3x + 5?", options: ["3", "5", "8", "15"], correct: 0 },
                { q: "Solve: x¬≤ - 9 = 0", options: ["x = 3 or x = -3", "x = 9", "x = 3", "x = -3"], correct: 0 },
                { q: "What is the integral of 2x?", options: ["x¬≤ + C", "2x¬≤ + C", "x + C", "2 + C"], correct: 0 },
                { q: "What is the value of 5! (5 factorial)?", options: ["120", "25", "10", "15"], correct: 0 },
                { q: "If a triangle has sides 3, 4, and 5, what type is it?", options: ["Right triangle", "Equilateral", "Isosceles", "Scalene"], correct: 0 },
                { q: "What is the formula for the volume of a cylinder?", options: ["œÄr¬≤h", "2œÄr¬≤h", "œÄrh", "r¬≤h"], correct: 0 },
                { q: "Evaluate: 2¬≥ √ó 2¬≤", options: ["32", "16", "64", "8"], correct: 0 },
                { q: "What is the square root of 144?", options: ["12", "14", "24", "72"], correct: 0 },
                { q: "Solve: |x - 3| = 5", options: ["x = 8 or x = -2", "x = 2", "x = 8", "x = -2"], correct: 0 },
                { q: "What is the sum of angles in a triangle?", options: ["180¬∞", "90¬∞", "360¬∞", "270¬∞"], correct: 0 },
                { q: "What is the gradient of y = -2x + 4?", options: ["-2", "4", "2", "-4"], correct: 0 },
                { q: "Convert 0.75 to a fraction", options: ["3/4", "7/10", "75/100", "1/2"], correct: 0 },
                { q: "What is the range of the function f(x) = x¬≤ + 1?", options: ["[1, ‚àû)", "[0, ‚àû)", "(-‚àû, ‚àû)", "[1, 1]"], correct: 0 },
                { q: "Solve: 2À£ = 16", options: ["x = 4", "x = 8", "x = 2", "x = 16"], correct: 0 },
                { q: "What is the perimeter of a rectangle with length 8 and width 5?", options: ["26", "40", "13", "20"], correct: 0 }
            ],
            'Accounting': [
                { q: "Which accounting concept states that transactions should be recorded at their original cost?", options: ["Historical cost convention", "Realisation concept", "Going concern concept", "Matching concept"], correct: 0 },
                { q: "What does FIFO stand for in inventory valuation?", options: ["First In First Out", "Fixed Inventory Financial Order", "Financial Inventory First Order", "First Inventory Financial Out"], correct: 0 },
                { q: "Which of these is NOT a branch of accounting?", options: ["Tax Accounting", "Financial Accounting", "Cost Accounting", "Management Accounting"], correct: 0 },
                { q: "What is the purpose of a suspense account?", options: ["To balance the trial balance when errors are detected", "To record bad debts", "To calculate depreciation", "To prepare financial statements"], correct: 0 },
                { q: "In double entry bookkeeping, when an asset increases, what happens?", options: ["Debit the asset account", "Credit the asset account", "Debit the expense account", "Credit the income account"], correct: 0 },
                { q: "What is the accounting equation?", options: ["Assets = Liabilities + Capital", "Assets = Liabilities - Capital", "Capital = Assets + Liabilities", "Liabilities = Assets √ó Capital"], correct: 0 },
                { q: "Which financial statement shows the financial position at a point in time?", options: ["Balance Sheet", "Income Statement", "Cash Flow Statement", "Trial Balance"], correct: 0 },
                { q: "What is depreciation?", options: ["Allocation of asset cost over its useful life", "Increase in asset value", "Sale of asset", "Purchase of asset"], correct: 0 },
                { q: "What is the purpose of a bank reconciliation?", options: ["To match bank statement with cash book", "To calculate profit", "To record sales", "To prepare trial balance"], correct: 0 },
                { q: "What is bad debt?", options: ["Debt that cannot be recovered", "New debt", "Debt paid on time", "Total debt"], correct: 0 },
                { q: "What does IAS stand for?", options: ["International Accounting Standards", "Internal Accounting System", "Inventory Accounting System", "Income Accounting Standards"], correct: 0 },
                { q: "Which account records credit sales?", options: ["Sales Account", "Purchases Account", "Cash Account", "Capital Account"], correct: 0 },
                { q: "What is the purpose of the income statement?", options: ["To show profit or loss for a period", "To show assets and liabilities", "To record transactions", "To calculate depreciation"], correct: 0 },
                { q: "What is a credit note?", options: ["Document issued when goods are returned", "Document for payment", "Sales invoice", "Purchase order"], correct: 0 },
                { q: "What is the matching concept?", options: ["Expenses matched with related revenues", "Assets matched with liabilities", "Debits matched with credits", "Sales matched with purchases"], correct: 0 },
                { q: "What is working capital?", options: ["Current Assets - Current Liabilities", "Total Assets - Total Liabilities", "Fixed Assets - Current Assets", "Capital - Liabilities"], correct: 0 },
                { q: "What is the journal entry for cash sales?", options: ["Dr Cash, Cr Sales", "Dr Sales, Cr Cash", "Dr Purchases, Cr Cash", "Dr Cash, Cr Purchases"], correct: 0 },
                { q: "What is prepaid expense?", options: ["Expense paid in advance", "Expense not yet paid", "Revenue received", "Asset purchased"], correct: 0 },
                { q: "What is a contra account?", options: ["Account that reduces another account", "Main account", "Expense account", "Revenue account"], correct: 0 },
                { q: "What is the prudence concept?", options: ["Anticipate no profit, provide for all losses", "Record all profits", "Ignore losses", "Maximize profits"], correct: 0 },
                { q: "What is capital expenditure?", options: ["Spending on long-term assets", "Daily operating costs", "Revenue expenditure", "Short-term expense"], correct: 0 },
                { q: "What is the purpose of a cash book?", options: ["To record cash and bank transactions", "To calculate profit", "To list assets", "To record sales only"], correct: 0 },
                { q: "What is a petty cash book?", options: ["Record of small cash expenses", "Main cash account", "Bank statement", "Sales ledger"], correct: 0 },
                { q: "What is inventory valuation?", options: ["Determining cost of goods held", "Calculating sales", "Recording purchases", "Preparing balance sheet"], correct: 0 },
                { q: "What is the accounting period concept?", options: ["Business life divided into time periods", "Monthly reporting only", "Annual reporting only", "Continuous reporting"], correct: 0 }
            ],
            'Economics': [
                { q: "What is the study of individual economic units called?", options: ["Microeconomics", "Macroeconomics", "Econometrics", "International Economics"], correct: 0 },
                { q: "What happens to demand when price increases?", options: ["Demand decreases", "Demand increases", "Demand stays the same", "Supply increases"], correct: 0 },
                { q: "What is GDP?", options: ["Gross Domestic Product", "General Domestic Price", "Gross Domestic Price", "General Development Product"], correct: 0 },
                { q: "What causes a shift in the demand curve?", options: ["Changes in income, tastes, or prices of related goods", "Changes in price of the good itself", "Changes in supply", "Changes in quantity demanded"], correct: 0 },
                { q: "What is inflation?", options: ["A general increase in prices over time", "A decrease in prices", "Economic growth", "Unemployment rate"], correct: 0 },
                { q: "What is opportunity cost?", options: ["The value of the next best alternative forgone", "The cost of production", "Market price", "Total cost"], correct: 0 },
                { q: "What does the law of supply state?", options: ["Price and quantity supplied are directly related", "Price and quantity supplied are inversely related", "Supply is constant", "Supply equals demand"], correct: 0 },
                { q: "What is a market economy?", options: ["Economic decisions made by supply and demand", "Government controls all production", "No private property", "Barter system only"], correct: 0 },
                { q: "What is perfect competition?", options: ["Many buyers and sellers, homogeneous products", "Single seller", "Few sellers", "Government control"], correct: 0 },
                { q: "What is a monopoly?", options: ["Single seller with no close substitutes", "Many sellers", "Two sellers", "Government market"], correct: 0 },
                { q: "What is price elasticity of demand?", options: ["Responsiveness of quantity demanded to price changes", "Price changes", "Quantity changes", "Income changes"], correct: 0 },
                { q: "What causes inflation?", options: ["Too much money chasing too few goods", "Decrease in money supply", "Economic recession", "Decrease in demand"], correct: 0 },
                { q: "What is fiscal policy?", options: ["Government spending and taxation", "Money supply control", "Interest rates", "Exchange rates"], correct: 0 },
                { q: "What is monetary policy?", options: ["Control of money supply and interest rates", "Government spending", "Taxation", "Trade policy"], correct: 0 },
                { q: "What is unemployment?", options: ["People able and willing to work but without jobs", "People not working", "Total population", "Employed people"], correct: 0 },
                { q: "What is economic growth?", options: ["Increase in real GDP over time", "Increase in prices", "Increase in population", "Increase in exports"], correct: 0 },
                { q: "What is the multiplier effect?", options: ["Initial spending leads to larger increase in GDP", "Price increase", "Tax increase", "Unemployment increase"], correct: 0 },
                { q: "What is comparative advantage?", options: ["Ability to produce at lower opportunity cost", "Absolute production advantage", "Highest production", "Lowest cost"], correct: 0 },
                { q: "What is the balance of payments?", options: ["Record of all economic transactions with other countries", "Trade balance only", "Current account only", "Capital account only"], correct: 0 },
                { q: "What is a public good?", options: ["Non-excludable and non-rivalrous", "Private consumption", "Market good", "Government service"], correct: 0 },
                { q: "What is marginal utility?", options: ["Additional satisfaction from consuming one more unit", "Total satisfaction", "Average satisfaction", "Maximum satisfaction"], correct: 0 },
                { q: "What is the production possibility frontier?", options: ["Maximum output combinations with given resources", "Minimum output", "Average output", "Optimal output"], correct: 0 },
                { q: "What is a negative externality?", options: ["Cost imposed on third parties", "Benefit to third parties", "Private cost", "Public benefit"], correct: 0 },
                { q: "What is the Gini coefficient?", options: ["Measure of income inequality", "Measure of inflation", "Measure of GDP", "Measure of unemployment"], correct: 0 },
                { q: "What is stagflation?", options: ["Stagnant growth with high inflation", "High growth with low inflation", "Recession with deflation", "Boom with inflation"], correct: 0 }
            ],
            'Computer Science': [
                { q: "What is an algorithm?", options: ["A step-by-step procedure to solve a problem", "A programming language", "A computer program", "A data structure"], correct: 0 },
                { q: "What does CPU stand for?", options: ["Central Processing Unit", "Computer Personal Unit", "Central Program Unit", "Computer Processing Unit"], correct: 0 },
                { q: "What is a variable in programming?", options: ["A container for storing data", "A function", "A loop", "An algorithm"], correct: 0 },
                { q: "What is the time complexity of binary search?", options: ["O(log n)", "O(n)", "O(n¬≤)", "O(1)"], correct: 0 },
                { q: "What is an array?", options: ["A collection of elements of the same type stored contiguously", "A function", "A variable", "A loop structure"], correct: 0 },
                { q: "What does HTML stand for?", options: ["HyperText Markup Language", "High Tech Modern Language", "Home Tool Markup Language", "Hyperlink Text Markup Language"], correct: 0 },
                { q: "What is recursion?", options: ["A function calling itself", "A loop structure", "A data type", "A programming language"], correct: 0 },
                { q: "What is the purpose of an if-else statement?", options: ["To make decisions based on conditions", "To repeat code", "To store data", "To define functions"], correct: 0 },
                { q: "What is a linked list?", options: ["Data structure with nodes connected by pointers", "Array with fixed size", "Stack structure", "Queue structure"], correct: 0 },
                { q: "What is object-oriented programming (OOP)?", options: ["Programming paradigm using objects and classes", "Linear programming", "Functional programming", "Procedural programming"], correct: 0 },
                { q: "What is the time complexity of linear search?", options: ["O(n)", "O(log n)", "O(n¬≤)", "O(1)"], correct: 0 },
                { q: "What is a stack?", options: ["LIFO (Last In First Out) data structure", "FIFO structure", "Random access structure", "Tree structure"], correct: 0 },
                { q: "What is a queue?", options: ["FIFO (First In First Out) data structure", "LIFO structure", "Random access structure", "Tree structure"], correct: 0 },
                { q: "What is a binary tree?", options: ["Tree with at most two children per node", "Tree with three children", "Linear structure", "Circular structure"], correct: 0 },
                { q: "What is pseudocode?", options: ["Informal language to describe algorithms", "Programming language", "Machine code", "Assembly language"], correct: 0 },
                { q: "What is the purpose of a loop?", options: ["To repeat code multiple times", "To make decisions", "To store data", "To define functions"], correct: 0 },
                { q: "What is debugging?", options: ["Finding and fixing errors in code", "Writing code", "Running code", "Compiling code"], correct: 0 },
                { q: "What is RAM?", options: ["Random Access Memory", "Read Access Memory", "Random Arithmetic Memory", "Read Arithmetic Memory"], correct: 0 },
                { q: "What is a compiler?", options: ["Translates high-level code to machine code", "Executes code", "Debugs code", "Stores code"], correct: 0 },
                { q: "What is the difference between compiler and interpreter?", options: ["Compiler translates before execution, interpreter translates during execution", "No difference", "Both translate after execution", "Both translate before execution"], correct: 0 },
                { q: "What is a function?", options: ["Reusable block of code", "Variable", "Data type", "Operator"], correct: 0 },
                { q: "What is encapsulation in OOP?", options: ["Bundling data and methods together", "Inheritance", "Polymorphism", "Abstraction"], correct: 0 },
                { q: "What is inheritance in OOP?", options: ["Classes inheriting properties from parent classes", "Data encapsulation", "Code reuse", "Polymorphism"], correct: 0 },
                { q: "What is the time complexity of bubble sort?", options: ["O(n¬≤)", "O(n log n)", "O(n)", "O(log n)"], correct: 0 },
                { q: "What is a database?", options: ["Organized collection of data", "Computer program", "Data structure", "Algorithm"], correct: 0 }
            ],
            'Business Studies': [
                { q: "What is SWOT analysis?", options: ["Strengths, Weaknesses, Opportunities, Threats", "Sales, Wages, Operations, Training", "Strategic, Work, Organizational, Tactical", "System, Workflow, Order, Technology"], correct: 0 },
                { q: "What is the marketing mix also known as?", options: ["4 Ps (Product, Price, Place, Promotion)", "4 Cs (Customer, Cost, Convenience, Communication)", "4 Ms (Market, Money, Media, Message)", "Both A and B"], correct: 3 },
                { q: "What is leadership?", options: ["The ability to influence others to achieve goals", "Managing employees", "Making decisions", "Planning strategies"], correct: 0 },
                { q: "What is a sole proprietorship?", options: ["A business owned by one person", "A partnership", "A corporation", "A franchise"], correct: 0 },
                { q: "What is the break-even point?", options: ["Where total revenue equals total costs", "Maximum profit point", "Minimum loss point", "Market equilibrium"], correct: 0 },
                { q: "What is human resource management?", options: ["Managing employees and workforce", "Marketing products", "Financial planning", "Production control"], correct: 0 },
                { q: "What is market segmentation?", options: ["Dividing market into distinct groups", "Setting prices", "Advertising strategy", "Product development"], correct: 0 },
                { q: "What is cash flow?", options: ["Movement of money in and out of business", "Total profit", "Revenue only", "Expenses only"], correct: 0 },
                { q: "What is a partnership?", options: ["Business owned by 2 or more people", "Single owner business", "Public company", "Franchise"], correct: 0 },
                { q: "What is motivation?", options: ["Factors that drive people to achieve goals", "Employee salary", "Job title", "Work location"], correct: 0 },
                { q: "What is delegation?", options: ["Assigning authority and responsibility to subordinates", "Hiring employees", "Firing employees", "Training employees"], correct: 0 },
                { q: "What is a business plan?", options: ["Document outlining business goals and strategies", "Employee contract", "Sales invoice", "Balance sheet"], correct: 0 },
                { q: "What is product lifecycle?", options: ["Stages from introduction to decline", "Product design only", "Product launch only", "Product disposal only"], correct: 0 },
                { q: "What is the difference between management and leadership?", options: ["Management is about control, leadership is about influence", "No difference", "Leadership is control", "Management is influence"], correct: 0 },
                { q: "What is corporate social responsibility (CSR)?", options: ["Business practices benefiting society", "Profit maximization", "Cost reduction", "Market expansion"], correct: 0 },
                { q: "What is supply chain management?", options: ["Managing flow of goods from supplier to consumer", "Managing employees", "Managing finances", "Managing marketing"], correct: 0 },
                { q: "What is quality control?", options: ["Ensuring products meet standards", "Reducing costs", "Increasing prices", "Expanding markets"], correct: 0 },
                { q: "What is a mission statement?", options: ["Business purpose and values", "Financial statement", "Employee handbook", "Sales report"], correct: 0 },
                { q: "What is productivity?", options: ["Output per unit of input", "Total output", "Total input", "Profit margin"], correct: 0 },
                { q: "What is organizational structure?", options: ["How business is organized and managed", "Building layout", "Product design", "Marketing strategy"], correct: 0 },
                { q: "What is budgeting?", options: ["Financial planning for future periods", "Recording past transactions", "Calculating profit", "Listing assets"], correct: 0 },
                { q: "What is customer relationship management (CRM)?", options: ["Managing interactions with customers", "Managing employees", "Managing inventory", "Managing finances"], correct: 0 },
                { q: "What is a stakeholder?", options: ["Anyone affected by business decisions", "Shareholders only", "Employees only", "Customers only"], correct: 0 },
                { q: "What is entrepreneurship?", options: ["Starting and running a business venture", "Working for a company", "Investing money", "Managing employees"], correct: 0 },
                { q: "What is competitive advantage?", options: ["Superior position over competitors", "Market share", "Profit margin", "Sales volume"], correct: 0 }
            ]
        };
        
        // Quiz questions will be set by generateQuiz()

        // Select Subject
        function selectSubject(subject) {
            try {
                currentSubject = subject;
                
                // Refresh homework submissions when subject changes
                if (typeof displayHomeworkSubmissions === 'function') {
                    displayHomeworkSubmissions();
                }
                
                // Hide homepage and show main content
                const homePage = document.getElementById('homePage');
                const mainContent = document.getElementById('mainContent');
                
                if (homePage) {
                    homePage.style.display = 'none';
                }
                
                if (mainContent) {
                    mainContent.style.display = 'block';
                }
                
                // Update header title
                const headerTitle = document.querySelector('.header h1');
                if (headerTitle) {
                    headerTitle.textContent = `üéì ${subject} Learning Session`;
                }
            
            // Update quiz questions for selected subject
            if (typeof subjectQuizQuestions !== "undefined") {
                quizQuestions = subjectQuizQuestions[subject] || subjectQuizQuestions['Mathematics'];
            }
            
            // Update AI tutor welcome message
            updateWelcomeMessage(subject);
            
            // Update homework subject display
            const subjectDisplay = document.getElementById('current-subject-display');
            if (subjectDisplay) {
                subjectDisplay.textContent = subject;
            }
            
            // Update AI tutor subject display
            const aiTutorSubjectDisplay = document.getElementById('ai-tutor-subject-display');
            if (aiTutorSubjectDisplay) {
                aiTutorSubjectDisplay.textContent = subject;
            }
            
            // Initialize quiz UI with new subject
            initQuizUI();
            
            // Reset old quiz variables
            quizScore = 0;
            if (typeof answeredQuestions !== "undefined") {
                answeredQuestions.clear();
            }
            
            // Ensure AI Tutor section is shown by default
            const aiTutorSection = document.getElementById('ai-tutor');
            if (aiTutorSection) {
                // Hide all sections
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                // Show AI Tutor section
                aiTutorSection.classList.add('active');
                
                // Activate AI Tutor tab button
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-section') === 'ai-tutor') {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Update progress display if viewing progress section
            if (document.getElementById('progress') && document.getElementById('progress').classList.contains('active')) {
                if (typeof updateProgressDisplay === 'function') {
                    updateProgressDisplay(currentSubject);
                }
            }
            
            console.log('‚úì Subject selected successfully:', subject);
            
            } catch (error) {
                console.error('‚úó Error in selectSubject:', error);
                alert('Error selecting subject: ' + (error.message || error) + '\n\nPlease refresh the page and try again.');
            }
        }
        
        function updateWelcomeMessage(subject) {
            // Welcome message removed - AI tutor agent will respond directly to user queries
            // No automatic welcome message displayed
        }

        // Show Sections
        function showSection(section, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            btn.classList.add('active');
            
            // Initialize quiz UI when quiz section is shown
            if (section === 'quiz' && typeof initQuizUI === 'function') {
                initQuizUI();
            }
            
            // Update progress display when progress section is shown
            if (section === 'progress' && typeof updateProgressDisplay === 'function') {
                updateProgressDisplay(currentSubject || 'Mathematics');
            }
            
            // Test backend connection when AI Tutor section is shown
            if (section === 'ai-tutor') {
                testBackendConnection();
            }
            
            // Track section change for time tracking
            if (currentSection && currentSection !== section) {
                // Save time spent in previous section
                const now = Date.now();
                const timeSpent = Math.floor((now - sectionStartTime) / 1000);
                if (timeSpent > 10) { // Only save if more than 10 seconds
                    saveTimeSpent(currentSection, timeSpent);
                }
            }
            
            currentSection = section;
            sectionStartTime = Date.now();
            
            // Update analysis when viewing analysis section
            if (section === 'analysis') {
                updateAnalysis();
            }
            
            // Update progress when viewing progress section
            if (section === 'progress') {
                updateProgressDisplay(currentProgressSubject || 'all');
            }
        }
        
        // Test backend connection
        async function testBackendConnection() {
            try {
                const res = await fetch('http://localhost:5050/health', {
                    method: 'GET',
                    signal: AbortSignal.timeout(3000)
                });
                if (res.ok) {
                    console.log('‚úì Backend connection successful');
                } else {
                    console.warn('‚ö† Backend health check returned:', res.status);
                }
            } catch (e) {
                console.warn('‚ö† Backend connection test failed:', e.message);
                // Don't show error to user, just log it
            }
        }

        // AI Chat - Updated to use FastAPI backend
        // File attachment management
        let attachedFiles = [];
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let recognition = null;
        let recordingStartTime = null;
        let recordingTimer = null;
        let synth = window.speechSynthesis;
        
        // Initialize Web Speech API for voice recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                const transcriptionEl = document.getElementById('voiceTranscription');
                if (transcriptionEl) {
                    transcriptionEl.textContent = finalTranscript || interimTranscript || 'Listening...';
                    // Auto-update chat input
                    if (finalTranscript) {
                        document.getElementById('chatInput').value = finalTranscript.trim();
                    }
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
            };
        }
        
        // Toggle attachment menu
        function toggleAttachmentMenu() {
            const menu = document.getElementById('attachmentMenu');
            if (menu) {
                menu.classList.toggle('show');
            }
        }
        
        // Close attachment menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('attachmentMenu');
            const attachBtn = document.querySelector('.file-attach-btn');
            if (menu && !menu.contains(e.target) && !attachBtn.contains(e.target)) {
                menu.classList.remove('show');
            }
        });
        
        // Attachment menu functions
        function openCamera() {
            document.getElementById('cameraInput').click();
            toggleAttachmentMenu();
        }
        
        function openPhotos() {
            document.getElementById('photosInput').click();
            toggleAttachmentMenu();
        }
        
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const locationText = `üìç Location: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        document.getElementById('chatInput').value = locationText;
                        addMessage(locationText, 'user');
                        toggleAttachmentMenu();
                    },
                    function(error) {
                        alert('Could not get your location. Please enable location services.');
                        toggleAttachmentMenu();
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser.');
                toggleAttachmentMenu();
            }
        }
        
        function openEventPicker() {
            const eventName = prompt('Enter event name:');
            if (eventName) {
                const eventDate = prompt('Enter event date (YYYY-MM-DD):');
                if (eventDate) {
                    const eventText = `üìÖ Event: ${eventName} on ${eventDate}`;
                    document.getElementById('chatInput').value = eventText;
                    addMessage(eventText, 'user');
                }
            }
            toggleAttachmentMenu();
        }
        
        // Handle camera and photos input
        document.getElementById('cameraInput')?.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (!attachedFiles.find(f => f.name === file.name && f.size === file.size)) {
                    attachedFiles.push(file);
                }
            });
            updateAttachedFilesDisplay();
        });
        
        document.getElementById('photosInput')?.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (!attachedFiles.find(f => f.name === file.name && f.size === file.size)) {
                    attachedFiles.push(file);
                }
            });
            updateAttachedFilesDisplay();
        });
        
        document.getElementById('chatFileInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (!attachedFiles.find(f => f.name === file.name && f.size === file.size)) {
                    attachedFiles.push(file);
                }
            });
            updateAttachedFilesDisplay();
        });
        
        // Voice Recording Functions
        async function startVoiceRecording() {
            if (isRecording) {
                stopVoiceRecording();
                return;
            }
            
            try {
                // Start speech recognition
                if (recognition) {
                    recognition.start();
                }
                
                // Start audio recording
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioFile = new File([audioBlob], 'voice-message.webm', { type: 'audio/webm' });
                    
                    // Add audio file to attachments
                    attachedFiles.push(audioFile);
                    updateAttachedFilesDisplay();
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();
                
                // Update UI
                document.getElementById('voiceRecordBtn').classList.add('recording');
                document.getElementById('voiceRecordingDisplay').style.display = 'block';
                
                // Start timer
                recordingTimer = setInterval(() => {
                    if (recordingStartTime) {
                        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                        const minutes = Math.floor(elapsed / 60);
                        const seconds = elapsed % 60;
                        document.getElementById('recordingTime').textContent = 
                            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error starting voice recording:', error);
                alert('Could not start voice recording. Please check microphone permissions.');
            }
        }
        
        function stopVoiceRecording() {
            if (!isRecording) return;
            
            // Stop speech recognition
            if (recognition) {
                recognition.stop();
            }
            
            // Stop media recorder
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            isRecording = false;
            recordingStartTime = null;
            
            // Update UI
            document.getElementById('voiceRecordBtn').classList.remove('recording');
            document.getElementById('voiceRecordingDisplay').style.display = 'none';
            
            // Clear timer
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
        }
        
        // Text-to-Speech function
        function speakText(text) {
            // Remove HTML tags for speech
            const cleanText = text.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ');
            
            if (synth && cleanText) {
                // Stop any ongoing speech
                synth.cancel();
                
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                synth.speak(utterance);
            }
        }
        
        // Download solution as Word document
        // Format response like ChatGPT - clean, readable text
        function formatChatGPTResponse(text) {
            // Escape HTML first
            text = escapeHtml(text);
            
            // Convert markdown-style formatting to HTML
            // Bold text
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            // Italic
            text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
            // Code blocks
            text = text.replace(/```([\s\S]*?)```/g, '<pre style="background: #f5f5f5; padding: 12px; border-radius: 6px; overflow-x: auto; font-family: monospace; font-size: 14px; margin: 10px 0;"><code>$1</code></pre>');
            // Inline code
            text = text.replace(/`(.+?)`/g, '<code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-family: monospace; font-size: 14px;">$1</code>');
            
            // Headings
            text = text.replace(/^### (.+?)$/gm, '<h3 style="color: #667eea; margin-top: 16px; margin-bottom: 8px; font-size: 18px;">$1</h3>');
            text = text.replace(/^## (.+?)$/gm, '<h2 style="color: #667eea; margin-top: 20px; margin-bottom: 10px; font-size: 20px; border-bottom: 2px solid #667eea; padding-bottom: 5px;">$1</h2>');
            text = text.replace(/^# (.+?)$/gm, '<h1 style="color: #667eea; margin-top: 24px; margin-bottom: 12px; font-size: 24px;">$1</h1>');
            
            // Lists
            text = text.replace(/^\d+\.\s+(.+?)$/gm, '<li style="margin: 6px 0;">$1</li>');
            text = text.replace(/^[-‚Ä¢]\s+(.+?)$/gm, '<li style="margin: 6px 0; list-style-type: disc; margin-left: 20px;">$1</li>');
            
            // Line breaks - preserve double line breaks as paragraphs
            text = text.split('\n\n').map(para => {
                para = para.trim();
                if (!para) return '';
                // Wrap in paragraph if not already a heading/list/code
                if (!para.startsWith('<h') && !para.startsWith('<li') && !para.startsWith('<pre') && !para.startsWith('<code')) {
                    return `<p style="margin: 10px 0; line-height: 1.6; color: #333;">${para}</p>`;
                }
                return para;
            }).join('');
            
            // Single line breaks
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function downloadSolutionAsWord(subject, answer, question) {
            try {
                const response = await fetch('http://localhost:5050/api/chat/download-document', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subject: subject,
                        answer: answer,
                        question: question
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to generate document');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${subject}_Solution_${new Date().toISOString().split('T')[0]}.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error downloading document:', error);
                alert('Failed to download document. Please try again.');
            }
        }
        
        async function downloadSolutionAsPDF(subject, answer, question) {
            try {
                const response = await fetch('http://localhost:5050/api/chat/download-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subject: subject,
                        answer: answer,
                        question: question
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Failed to generate PDF' }));
                    throw new Error(errorData.error || 'Failed to generate PDF');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${subject}_Solution_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error downloading PDF:', error);
                alert('Failed to download PDF. ' + (error.message || 'Please try again. Note: PDF generation requires reportlab library on the backend.'));
            }
        }
        
        function updateAttachedFilesDisplay() {
            const container = document.getElementById('attachedFiles');
            container.innerHTML = '';
            
            attachedFiles.forEach((file, index) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'attached-file';
                fileDiv.innerHTML = `
                    <span>üìé</span>
                    <span>${file.name}</span>
                    <span class="attached-file-remove" onclick="removeAttachedFile(${index})">√ó</span>
                `;
                container.appendChild(fileDiv);
            });
        }
        
        function removeAttachedFile(index) {
            attachedFiles.splice(index, 1);
            updateAttachedFilesDisplay();
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            // Allow sending even if message is empty if files are attached
            if (!message && attachedFiles.length === 0) return;

            // Show user message
            let userMessageText = message || 'Please analyze the attached file(s)';
            if (attachedFiles.length > 0) {
                userMessageText += `\n\nüìé Attached ${attachedFiles.length} file(s): ${attachedFiles.map(f => f.name).join(', ')}`;
            }
            addMessage(userMessageText, 'user');
            input.value = '';
            
            // Show typing indicator
            const typingId = Date.now();
            addMessage('ü§ñ Analyzing your question and files...', 'ai', typingId);

            try {
                let res;
                
                // If files are attached, use FormData
                if (attachedFiles.length > 0) {
                    const formData = new FormData();
                    formData.append('subject', currentSubject || 'Mathematics');
                    formData.append('message', message || 'Please analyze the uploaded document and provide complete solutions to all problems, questions, or exercises it contains.');
                    
                    // Add files to form data
                    attachedFiles.forEach((file) => {
                        formData.append('files', file);
                    });

                    res = await fetch('http://localhost:5050/api/chat', {
                        method: 'POST',
                        body: formData,
                        signal: AbortSignal.timeout(60000) // 60 second timeout
                    });
                } else {
                    // No files, use JSON
                    res = await fetch('http://localhost:5050/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            subject: currentSubject || 'Mathematics',
                            message: message || 'Please help me learn.'
                        }),
                        signal: AbortSignal.timeout(60000) // 60 second timeout
                    });
                }

                if (!res.ok) {
                    const errorText = await res.text().catch(() => 'Unknown error');
                    throw new Error(`HTTP error! status: ${res.status}, response: ${errorText}`);
                }

                const data = await res.json();

                // Remove typing indicator
                const typingMsg = document.querySelector(`[data-typing-id="${typingId}"]`);
                if (typingMsg) typingMsg.remove();

                // Format response as plain text (like ChatGPT) - convert markdown to readable HTML
                let formattedAnswer = formatChatGPTResponse(data.answer);
                let text = formattedAnswer;

                if (data.used_syllabus && data.syllabus_snippets?.length) {
                    text += `<br><br><div style="background: #e3f2fd; padding: 12px; border-radius: 10px; border-left: 4px solid #2196f3; margin-top: 10px;">
                        <b>üìò Relevant Syllabus Content:</b><br>` + 
                        data.syllabus_snippets.map(s => `‚Ä¢ ${escapeHtml(s)}`).join('<br><br>') +
                        `</div>`;
                }

                if (data.external_sources?.length) {
                    text += `<br><br><div style="background: #fff3e0; padding: 12px; border-radius: 10px; border-left: 4px solid #ff9800; margin-top: 10px;">
                        <b>üåê External Sources:</b><br>` + 
                        data.external_sources.map(u => `‚Ä¢ <a href="${u}" target="_blank" style="color: #e65100;">${escapeHtml(u)}</a>`).join('<br>') +
                        `</div>`;
                }

                // Add action button (Voice Response only)
                const cleanAnswer = data.answer.replace(/<[^>]*>/g, '').replace(/`/g, '\\`').replace(/\$/g, '\\$');
                const voiceBtnHtml = `<button class="voice-response-btn" onclick="speakText(\`${cleanAnswer}\`)">üîä Play Voice Response</button>`;
                text += `<br><br><div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">${voiceBtnHtml}</div>`;
                
                addMessage(text, 'ai');
                
                // Audio playback is now manual only - user clicks "Play Voice Response" button
                
                studentComments.push(userMessageText);
                
                // Track follow-up questions
                trackFollowUpQuestion(userMessageText, text);
                
                // Clear attached files after sending
                attachedFiles = [];
                updateAttachedFilesDisplay();
                document.getElementById('chatFileInput').value = '';
                
            } catch (e) {
                // Remove typing indicator
                const typingMsg = document.querySelector(`[data-typing-id="${typingId}"]`);
                if (typingMsg) typingMsg.remove();
                
                console.error('Error:', e);
                let errorMsg = "‚ö†Ô∏è Error: ";
                
                if (e.name === 'AbortError' || e.message && e.message.includes('timeout')) {
                    errorMsg += "Request timed out. The backend might be processing a large file. Please try again with a smaller file or wait a bit longer.";
                } else if (e.message && (e.message.includes('Failed to fetch') || e.message.includes('NetworkError'))) {
                    errorMsg += "Cannot connect to backend server. Please ensure:\n\n";
                    errorMsg += "1. Backend server is running on port 5050\n";
                    errorMsg += "2. Run: cd backend && .venv\\Scripts\\activate && python -m uvicorn main:app --reload --port 5050\n";
                    errorMsg += "3. Check that the backend is accessible at http://localhost:5050/health\n\n";
                    errorMsg += "Current backend status: Check http://localhost:5050/health in your browser";
                } else if (e.message && e.message.includes('HTTP error')) {
                    errorMsg += e.message;
                } else {
                    errorMsg += (e.message || "An error occurred. Please check the browser console for details.");
                }
                addMessage(errorMsg, 'ai');
            }
        }
        
        function getAIResponse(message, subject) {
            const msg = message.toLowerCase();
            let response = '';
            
            if (!subject || subject === '') {
                return 'Please select a subject first to get started! üìö';
            }
            
            // Accounting responses (syllabus-aligned)
            if (subject === 'Accounting') {
                if (msg.includes('double entry') || msg.includes('double-entry')) {
                    return 'üìñ **Double Entry Bookkeeping**\n\nDouble entry means every transaction affects at least TWO accounts:\n\n‚Ä¢ **Rule**: Debit = Credit (always balanced)\n\n‚Ä¢ **Assets increase** ‚Üí Debit\n‚Ä¢ **Liabilities increase** ‚Üí Credit\n‚Ä¢ **Capital increases** ‚Üí Credit\n‚Ä¢ **Expenses increase** ‚Üí Debit\n‚Ä¢ **Income increases** ‚Üí Credit\n\n**Example**: Bought goods for $100 cash\n- Debit: Purchases $100\n- Credit: Cash $100\n\nüí° Remember: "Debit what comes in, Credit what goes out"';
                } else if (msg.includes('trial balance') || msg.includes('trial')) {
                    return 'üìä **Trial Balance**\n\nA Trial Balance lists all account balances to check if debits = credits.\n\n**Purpose**:\n1. Verify arithmetic accuracy\n2. Identify errors\n3. Prepare for financial statements\n\n**If it balances**: Books are arithmetically correct (but may still have errors!)\n\n**If it doesn\'t balance**: There are errors affecting the trial balance (suspense account needed)\n\n**Errors NOT affecting trial balance**:\n‚Ä¢ Omission\n‚Ä¢ Commission\n‚Ä¢ Principle\n‚Ä¢ Compensating errors';
                } else if (msg.includes('depreciation') || msg.includes('depreciat')) {
                    return 'üìâ **Depreciation (IAS 16)**\n\nDepreciation allocates the cost of non-current assets over their useful life.\n\n**Methods**:\n1. **Straight-line**: (Cost - Residual Value) √∑ Useful Life\n2. **Reducing balance**: Book Value √ó Rate%\n3. **Units of production**: Based on usage\n\n**Journal Entry**:\n- Dr: Depreciation Expense\n- Cr: Accumulated Depreciation (Provision for Depreciation)\n\nüí° Remember: Land is NOT depreciated (unlimited useful life)';
                } else if (msg.includes('bad debt') || msg.includes('doubtful')) {
                    return 'üí∞ **Bad Debts & Doubtful Debts**\n\n**Bad Debts**: Customers who will NEVER pay\n- Dr: Bad Debts Expense\n- Cr: Accounts Receivable (Customer account)\n\n**Doubtful Debts (Allowance)**: Potential bad debts (estimated)\n- Dr: Doubtful Debts Expense\n- Cr: Allowance for Doubtful Debts\n\n**Why needed**: Prudence concept - provide for potential losses\n\n**Calculation**: Usually % of receivables (e.g., 5% of outstanding debts)';
                } else if (msg.includes('bank reconciliation') || msg.includes('reconciliation')) {
                    return 'üè¶ **Bank Reconciliation Statement**\n\nReconciles cash book balance with bank statement balance.\n\n**Steps**:\n1. Start with cash book balance\n2. Add: Unpresented cheques, bank errors (overstatement)\n3. Less: Uncredited deposits, bank charges, direct debits, bank errors (understatement)\n4. Result should = Bank statement balance\n\n**Items in cash book but not in statement**:\n‚Ä¢ Unpresented cheques (deduct)\n‚Ä¢ Outstanding deposits (add)\n\n**Items in statement but not in cash book**:\n‚Ä¢ Bank charges, interest (deduct)\n‚Ä¢ Direct credits (add)';
                } else if (msg.includes('inventory') || msg.includes('fifo') || msg.includes('avco')) {
                    return 'üì¶ **Inventory Valuation (IAS 2)**\n\nInventory valued at **lower of Cost or Net Realisable Value**\n\n**Valuation Methods**:\n\n1. **FIFO (First In First Out)**:\n   - Assumes oldest items sold first\n   - Closing stock = latest prices\n   - Good in rising prices (lower COS)\n\n2. **AVCO (Weighted Average Cost)**:\n   - Average cost per unit = Total cost √∑ Total units\n   - Closing stock = Average cost √ó Units\n   - Smooths out price fluctuations\n\n**Net Realisable Value** = Selling Price - Selling Costs\n\nüí° Always compare Cost vs NRV and use the lower!';
                } else if (msg.includes('financial statement') || msg.includes('income statement') || msg.includes('statement of profit')) {
                    return 'üìã **Financial Statements (IAS 1)**\n\n**Components**:\n\n1. **Statement of Profit/Loss & Other Comprehensive Income**:\n   - Revenue\n   - Cost of Sales\n   - Gross Profit\n   - Operating Expenses\n   - Profit before Tax\n   - Tax\n   - Profit after Tax\n\n2. **Statement of Financial Position (Balance Sheet)**:\n   - **Assets**: Current & Non-current\n   - **Liabilities**: Current & Non-current\n   - **Equity**: Capital, Retained Earnings\n\n3. **Statement of Changes in Equity** (Companies)\n\n**Concepts applied**:\n‚Ä¢ Going concern\n‚Ä¢ Accruals/matching\n‚Ä¢ Prudence';
                } else if (msg.includes('cost accounting') || msg.includes('overhead') || msg.includes('absorption')) {
                    return 'üî¢ **Cost Accounting**\n\n**Elements of Cost**:\n1. **Direct Materials**: Raw materials used\n2. **Direct Labour**: Wages of workers\n3. **Overheads**: All indirect costs\n\n**Overhead Absorption**:\nAllocate overheads to products using:\n‚Ä¢ Direct Labour Hours Rate\n‚Ä¢ Machine Hours Rate\n‚Ä¢ % of Direct Cost\n\n**Formula**:\nAbsorption Rate = Total Overheads √∑ Total Activity Level\n\n**Absorption vs Marginal Costing**:\n‚Ä¢ **Absorption**: Includes fixed overheads in product cost\n‚Ä¢ **Marginal**: Only variable costs in product cost, fixed costs as period costs';
                } else if (msg.includes('budget') || msg.includes('budgetary')) {
                    return 'üìä **Budgeting & Budgetary Control**\n\n**Types of Budgets**:\n1. **Sales Budget**: Forecast sales units √ó price\n2. **Production Budget**: Sales + Closing Stock - Opening Stock\n3. **Purchases Budget**: Production needs + Closing Inventory - Opening Inventory\n4. **Cash Budget**: Cash receipts - Cash payments\n5. **Master Budget**: Summary of all budgets\n\n**Flexed Budget**: Adjusted budget for actual activity level\n\n**Variances**: Difference between actual and budget\n‚Ä¢ **Favorable**: Actual better than budget\n‚Ä¢ **Adverse**: Actual worse than budget';
                } else if (msg.includes('concept') || msg.includes('principle') || msg.includes('convention')) {
                    return 'üìê **Accounting Concepts & Principles**\n\n**Key Concepts**:\n\n1. **Historical Cost**: Record at original cost\n2. **Money Measurement**: Only measurable in money\n3. **Going Concern**: Business will continue operating\n4. **Accruals/Matching**: Match expenses to income period\n5. **Prudence**: Don\'t overstate profits/assets\n6. **Consistency**: Use same methods over time\n7. **Materiality**: Significant items only\n8. **Realisation**: Recognise revenue when earned\n9. **Substance over Form**: Economic reality matters\n\nüí° These ensure financial statements are reliable and comparable!';
                } else if (msg.includes('error') || msg.includes('suspense')) {
                    return '‚ö†Ô∏è **Errors & Suspense Account**\n\n**Errors NOT affecting Trial Balance**:\n‚Ä¢ Omission: Transaction not recorded\n‚Ä¢ Commission: Wrong account\n‚Ä¢ Principle: Wrong type (e.g., asset as expense)\n‚Ä¢ Compensating: Two errors canceling out\n\n**Errors AFFECTING Trial Balance**:\n‚Ä¢ Single entry\n‚Ä¢ Wrong amount\n‚Ä¢ Casting errors\n\n**Correction**: Use Suspense Account temporarily\n\n**Example**: Paid $500 but recorded $50\n- Corrected: Dr Expense $450, Cr Suspense $450';
                } else {
                    return `Great question about Accounting! üìäüí∞\n\nI can help you with:\n‚Ä¢ Double Entry Bookkeeping\n‚Ä¢ Trial Balance & Errors\n‚Ä¢ Financial Statements (IAS 1)\n‚Ä¢ Inventory Valuation (IAS 2, FIFO, AVCO)\n‚Ä¢ Depreciation (IAS 16)\n‚Ä¢ Bank Reconciliation\n‚Ä¢ Cost & Management Accounting\n‚Ä¢ Budgeting & Investment Appraisal\n\nWhat specific topic would you like to learn about? üí°`;
                }
            }
            
            // Mathematics responses
            else if (subject === 'Mathematics') {
                if (msg.includes('simultaneous') || msg.includes('simultaneous equation')) {
                    return 'üßÆ **Simultaneous Equations**\n\n**Method 1: Elimination**\n1. Write equations: 2x + 3y = 7, x - y = 1\n2. Multiply 2nd eq by 3: 3x - 3y = 3\n3. Add to 1st: 5x = 10 ‚Üí x = 2\n4. Substitute: 2 - y = 1 ‚Üí y = 1\n\n**Answer: x=2, y=1**\n\n**Method 2: Substitution**\nFrom 2nd eq: x = y + 1\nSubstitute into 1st: 2(y+1) + 3y = 7\nSolve for y, then find x';
                } else if (msg.includes('quadratic') || msg.includes('quadratic formula')) {
                    return 'üìê **Quadratic Formula**\n\nFor equation: ax¬≤ + bx + c = 0\n\n**Formula**: x = (-b ¬± ‚àö(b¬≤-4ac)) / 2a\n\n**Discriminant**: b¬≤ - 4ac\n‚Ä¢ If > 0: Two real solutions\n‚Ä¢ If = 0: One real solution\n‚Ä¢ If < 0: No real solutions (complex)\n\n**Example**: x¬≤ - 5x + 6 = 0\nx = (5 ¬± ‚àö(25-24)) / 2\nx = (5 ¬± 1) / 2\nx = 3 or x = 2';
                } else if (msg.includes('factor') || msg.includes('factoriz')) {
                    return 'üî¢ **Factorization**\n\n**General form**: x¬≤ + bx + c\nFind two numbers that:\n‚Ä¢ Multiply to give c\n‚Ä¢ Add to give b\n\n**Example**: x¬≤ + 5x + 6\nFind: ? √ó ? = 6, ? + ? = 5\nAnswer: 2 and 3\nSo: (x+2)(x+3)\n\n**Difference of squares**: x¬≤ - a¬≤ = (x+a)(x-a)\n**Perfect square**: x¬≤ + 2ax + a¬≤ = (x+a)¬≤';
                } else if (msg.includes('derivative') || msg.includes('differentiation') || msg.includes('differentiate')) {
                    return 'üìà **Differentiation (Calculus)**\n\n**Basic Rules**:\n‚Ä¢ **Power Rule**: d/dx(x‚Åø) = nx‚Åø‚Åª¬π\n  Example: d/dx(x¬≥) = 3x¬≤\n‚Ä¢ **Constant Rule**: d/dx(c) = 0\n‚Ä¢ **Sum Rule**: d/dx(f+g) = f\' + g\'\n‚Ä¢ **Product Rule**: d/dx(fg) = f\'g + fg\'\n‚Ä¢ **Quotient Rule**: d/dx(f/g) = (f\'g - fg\')/g¬≤\n\n**Example**:\nd/dx(x¬≤) = 2x\nd/dx(5x¬≥ + 2x) = 15x¬≤ + 2\n\nüí° Derivatives show rate of change/slope!';
                } else if (msg.includes('integral') || msg.includes('integration') || msg.includes('integrate')) {
                    return 'üìä **Integration (Calculus)**\n\n**Basic Rules**:\n‚Ä¢ **Power Rule**: ‚à´x‚Åø dx = x‚Åø‚Å∫¬π/(n+1) + C\n  Example: ‚à´x¬≤ dx = x¬≥/3 + C\n‚Ä¢ **Constant**: ‚à´c dx = cx + C\n‚Ä¢ **Sum**: ‚à´(f+g) dx = ‚à´f dx + ‚à´g dx\n\n**Example**:\n‚à´3x¬≤ dx = x¬≥ + C\n‚à´(2x + 5) dx = x¬≤ + 5x + C\n\nüí° Integration finds area under a curve!';
                } else if (msg.includes('log') || msg.includes('logarithm')) {
                    return 'üìê **Logarithms**\n\n**Definition**: log‚Çê(b) = c means a·∂ú = b\n\n**Rules**:\n‚Ä¢ log(ab) = log(a) + log(b)\n‚Ä¢ log(a/b) = log(a) - log(b)\n‚Ä¢ log(a‚Åø) = n¬∑log(a)\n‚Ä¢ log‚Çê(a) = 1\n‚Ä¢ log‚Çê(1) = 0\n\n**Common Logs**:\n‚Ä¢ log‚ÇÅ‚ÇÄ(x) = log(x) - base 10\n‚Ä¢ ln(x) = log‚Çë(x) - natural log (base e)\n\n**Example**:\nIf log‚ÇÅ‚ÇÄ(x) = 2, then x = 10¬≤ = 100';
                } else if (msg.includes('trig') || msg.includes('sine') || msg.includes('cosine') || msg.includes('tangent')) {
                    return 'üìê **Trigonometry**\n\n**Basic Ratios** (Right Triangle):\n‚Ä¢ sin(Œ∏) = Opposite/Hypotenuse\n‚Ä¢ cos(Œ∏) = Adjacent/Hypotenuse\n‚Ä¢ tan(Œ∏) = Opposite/Adjacent\n\n**Key Values**:\nsin(0¬∞) = 0, sin(30¬∞) = 1/2, sin(45¬∞) = ‚àö2/2, sin(60¬∞) = ‚àö3/2, sin(90¬∞) = 1\ncos(0¬∞) = 1, cos(30¬∞) = ‚àö3/2, cos(45¬∞) = ‚àö2/2, cos(60¬∞) = 1/2, cos(90¬∞) = 0\n\n**Identities**:\nsin¬≤(Œ∏) + cos¬≤(Œ∏) = 1\ntan(Œ∏) = sin(Œ∏)/cos(Œ∏)';
                } else if (msg.includes('geometry') || msg.includes('area') || msg.includes('volume') || msg.includes('perimeter')) {
                    return 'üìê **Geometry - Areas & Volumes**\n\n**Areas**:\n‚Ä¢ Rectangle: length √ó width\n‚Ä¢ Triangle: ¬Ω √ó base √ó height\n‚Ä¢ Circle: œÄr¬≤\n‚Ä¢ Trapezium: ¬Ω(a+b)h\n\n**Perimeters**:\n‚Ä¢ Rectangle: 2(length + width)\n‚Ä¢ Circle: 2œÄr\n‚Ä¢ Triangle: sum of sides\n\n**Volumes**:\n‚Ä¢ Cuboid: length √ó width √ó height\n‚Ä¢ Cylinder: œÄr¬≤h\n‚Ä¢ Sphere: (4/3)œÄr¬≥\n‚Ä¢ Cone: (1/3)œÄr¬≤h';
                } else if (msg.includes('algebra') || msg.includes('solve') || msg.includes('equation')) {
                    return 'üî¢ **Solving Linear Equations**\n\n**Steps**:\n1. Simplify both sides\n2. Collect like terms\n3. Isolate variable\n4. Check solution\n\n**Example**: 3x - 7 = 2x + 5\n1. 3x - 2x = 5 + 7\n2. x = 12\n\n**Check**: 3(12) - 7 = 36 - 7 = 29\n           2(12) + 5 = 24 + 5 = 29 ‚úì\n\nüí° Whatever you do to one side, do to the other!';
                } else {
                    return `Great question about Mathematics! üìê\n\nI can help with:\n‚Ä¢ Algebra & Linear Equations\n‚Ä¢ Simultaneous Equations\n‚Ä¢ Quadratic Equations & Factorization\n‚Ä¢ Geometry (Areas, Volumes, Shapes)\n‚Ä¢ Calculus (Differentiation, Integration)\n‚Ä¢ Trigonometry\n‚Ä¢ Logarithms\n‚Ä¢ Coordinate Geometry\n\nWhat specific topic would you like help with? üí°`;
                }
            }
            
            // Economics responses
            else if (subject === 'Economics') {
                if (msg.includes('demand') || msg.includes('supply')) {
                    return 'üìà **Demand & Supply**\n\n**Law of Demand**: Price ‚Üë ‚Üí Quantity Demanded ‚Üì (inverse relationship)\n\n**Law of Supply**: Price ‚Üë ‚Üí Quantity Supplied ‚Üë (direct relationship)\n\n**Equilibrium**: Where demand = supply (market clearing price)\n\n**Shifts**:\n‚Ä¢ Demand shifts: Income, tastes, prices of related goods, expectations\n‚Ä¢ Supply shifts: Costs, technology, number of sellers, expectations';
                } else if (msg.includes('gdp') || msg.includes('gross domestic')) {
                    return 'üåç **GDP (Gross Domestic Product)**\n\nTotal value of goods and services produced in a country in a period.\n\n**Calculation Methods**:\n1. **Expenditure**: C + I + G + (X-M)\n   - C = Consumption\n   - I = Investment\n   - G = Government spending\n   - X = Exports, M = Imports\n\n2. **Income**: Wages + Rent + Interest + Profit\n\n3. **Output**: Value added by all industries\n\n**Real GDP**: Adjusted for inflation\n**Nominal GDP**: Current prices';
                } else if (msg.includes('inflation') || msg.includes('deflation')) {
                    return 'üíπ **Inflation**\n\n**Definition**: General increase in price level over time, reducing purchasing power.\n\n**Causes**:\n‚Ä¢ Demand-pull: Too much demand\n‚Ä¢ Cost-push: Rising production costs\n‚Ä¢ Monetary: Too much money supply\n\n**Effects**:\n‚Ä¢ Reduces purchasing power\n‚Ä¢ Encourages spending now\n‚Ä¢ Hurts savers\n‚Ä¢ Can redistribute wealth\n\n**Measurement**: Consumer Price Index (CPI)\n**Inflation Rate** = (CPI‚ÇÇ - CPI‚ÇÅ)/CPI‚ÇÅ √ó 100%';
                } else if (msg.includes('unemployment') || msg.includes('employment')) {
                    return 'üë• **Unemployment**\n\n**Types**:\n‚Ä¢ **Frictional**: Between jobs (temporary)\n‚Ä¢ **Structural**: Skills mismatch\n‚Ä¢ **Cyclical**: Economic downturn\n‚Ä¢ **Seasonal**: Weather-related\n\n**Unemployment Rate** = (Unemployed/Labor Force) √ó 100%\n\n**Costs**:\n‚Ä¢ Lost output\n‚Ä¢ Social problems\n‚Ä¢ Government spending on benefits\n‚Ä¢ Human capital depreciation';
                } else if (msg.includes('elasticity') || msg.includes('elastic')) {
                    return 'üìä **Elasticity**\n\n**Price Elasticity of Demand (PED)**:\n% change in quantity demanded / % change in price\n\n‚Ä¢ **Elastic** (|PED| > 1): Responsive to price\n‚Ä¢ **Inelastic** (|PED| < 1): Not responsive\n‚Ä¢ **Unit elastic** (|PED| = 1)\n\n**Income Elasticity**:\n% change in demand / % change in income\n\n‚Ä¢ **Normal goods**: Positive\n‚Ä¢ **Inferior goods**: Negative\n\n**Cross Elasticity**:\n% change in demand for A / % change in price of B\n‚Ä¢ **Substitutes**: Positive\n‚Ä¢ **Complements**: Negative';
                } else if (msg.includes('market') || msg.includes('competition') || msg.includes('monopoly')) {
                    return 'üè™ **Market Structures**\n\n1. **Perfect Competition**:\n   ‚Ä¢ Many buyers/sellers\n   ‚Ä¢ Homogeneous products\n   ‚Ä¢ No barriers to entry\n   ‚Ä¢ Price takers\n\n2. **Monopoly**:\n   ‚Ä¢ Single seller\n   ‚Ä¢ No close substitutes\n   ‚Ä¢ High barriers\n   ‚Ä¢ Price maker\n\n3. **Monopolistic Competition**:\n   ‚Ä¢ Many sellers\n   ‚Ä¢ Differentiated products\n   ‚Ä¢ Some price control\n\n4. **Oligopoly**:\n   ‚Ä¢ Few large firms\n   ‚Ä¢ Interdependent decisions';
                } else if (msg.includes('opportunity cost') || msg.includes('opportunity')) {
                    return '‚öñÔ∏è **Opportunity Cost**\n\n**Definition**: Value of the next best alternative forgone when making a choice.\n\n**Example**:\nIf you spend $10 on a movie:\n‚Ä¢ Opportunity cost = What else you could have bought\n‚Ä¢ Could be: Book, Food, Savings, etc.\n\n**Importance**:\n‚Ä¢ Shows true cost of decisions\n‚Ä¢ Helps with resource allocation\n‚Ä¢ Key to economic reasoning\n\nüí° There\'s no free lunch - everything has an opportunity cost!';
                } else if (msg.includes('micro') || msg.includes('macro')) {
                    return 'üìö **Microeconomics vs Macroeconomics**\n\n**Microeconomics** (Individual level):\n‚Ä¢ Individual consumers, firms\n‚Ä¢ Demand & supply\n‚Ä¢ Market structures\n‚Ä¢ Price determination\n‚Ä¢ Resource allocation\n\n**Macroeconomics** (National level):\n‚Ä¢ GDP, inflation, unemployment\n‚Ä¢ Economic growth\n‚Ä¢ Fiscal & monetary policy\n‚Ä¢ International trade\n‚Ä¢ Aggregate demand/supply\n\nüí° Micro = Trees, Macro = Forest';
                } else {
                    return `Great question about Economics! üìà\n\nI can help with:\n‚Ä¢ Microeconomics (Demand, Supply, Market structures, Elasticity)\n‚Ä¢ Macroeconomics (GDP, Inflation, Unemployment, Economic growth)\n‚Ä¢ Market forces & equilibrium\n‚Ä¢ Opportunity cost\n‚Ä¢ International trade\n‚Ä¢ Fiscal & Monetary policy\n\nWhat would you like to learn? üí°`;
                }
            }
            
            // Computer Science responses
            else if (subject === 'Computer Science') {
                if (msg.includes('algorithm')) {
                    return 'üíª **Algorithms**\n\nAn algorithm is a step-by-step procedure to solve a problem.\n\n**Characteristics**:\n‚Ä¢ Clear and unambiguous\n‚Ä¢ Input and output defined\n‚Ä¢ Finite (must terminate)\n‚Ä¢ Effective (each step can be done)\n\n**Example - Finding Maximum**:\n1. Set max = first number\n2. For each remaining number:\n   - If number > max, set max = number\n3. Return max\n\n**Complexity**: Time & Space efficiency matter!';
                } else if (msg.includes('variable') || msg.includes('data type')) {
                    return 'üî§ **Variables & Data Types**\n\n**Variable**: Named storage location for data\n\n**Common Data Types**:\n‚Ä¢ **Integer**: Whole numbers (1, -5, 100)\n‚Ä¢ **Float/Double**: Decimals (3.14, 2.5)\n‚Ä¢ **String**: Text ("Hello", "World")\n‚Ä¢ **Boolean**: True/False\n‚Ä¢ **Array**: List of values\n\n**Declaration Example**:\nint age = 20;\nstring name = "John";\nbool isStudent = true;';
                } else if (msg.includes('loop') || msg.includes('for') || msg.includes('while')) {
                    return 'üîÑ **Loops**\n\n**For Loop**:\nfor (int i = 0; i < 10; i++) {\n    // code to repeat\n}\n\n**While Loop**:\nwhile (condition) {\n    // code to repeat\n}\n\n**Do-While Loop**:\ndo {\n    // code\n} while (condition);\n\n**Use**: Repeat code multiple times\n**Choose**:\n‚Ä¢ For: Known iterations\n‚Ä¢ While: Unknown iterations, condition first\n‚Ä¢ Do-while: Execute at least once';
                } else if (msg.includes('array') || msg.includes('list')) {
                    return 'üìã **Arrays & Lists**\n\n**Array**: Fixed-size collection of same type\nint numbers[5] = {1, 2, 3, 4, 5};\n\n**List**: Dynamic collection\n\n**Operations**:\n‚Ä¢ Access: array[index]\n‚Ä¢ Length: array.length\n‚Ä¢ Search: Linear O(n) or Binary O(log n)\n‚Ä¢ Sort: Various algorithms\n\n**2D Array**: Array of arrays\nint matrix[3][3];\n\nüí° Arrays start at index 0!';
                } else if (msg.includes('function') || msg.includes('method')) {
                    return '‚öôÔ∏è **Functions/Methods**\n\n**Purpose**: Reusable code block\n\n**Structure**:\nreturnType functionName(parameters) {\n    // code\n    return value;\n}\n\n**Example**:\nint add(int a, int b) {\n    return a + b;\n}\n\n**Benefits**:\n‚Ä¢ Code reuse\n‚Ä¢ Modularity\n‚Ä¢ Easier debugging\n‚Ä¢ Better organization\n\n**Types**:\n‚Ä¢ Void (no return)\n‚Ä¢ Value-returning\n‚Ä¢ Parameters (inputs)';
                } else if (msg.includes('if') || msg.includes('else') || msg.includes('conditional')) {
                    return '‚ùì **Conditional Statements**\n\n**If-Else**:\nif (condition) {\n    // code if true\n} else {\n    // code if false\n}\n\n**If-Else If-Else**:\nif (score >= 90) {\n    grade = "A";\n} else if (score >= 80) {\n    grade = "B";\n} else {\n    grade = "C";\n}\n\n**Operators**:\n‚Ä¢ == (equal)\n‚Ä¢ != (not equal)\n‚Ä¢ >, <, >=, <=\n‚Ä¢ && (and), || (or)';
                } else if (msg.includes('complexity') || msg.includes('big o') || msg.includes('time complexity')) {
                    return '‚è±Ô∏è **Time Complexity (Big O)**\n\nMeasures algorithm efficiency:\n\n‚Ä¢ **O(1)**: Constant time (best)\n‚Ä¢ **O(log n)**: Logarithmic (excellent)\n‚Ä¢ **O(n)**: Linear\n‚Ä¢ **O(n log n)**: Linearithmic\n‚Ä¢ **O(n¬≤)**: Quadratic (slow)\n‚Ä¢ **O(2‚Åø)**: Exponential (very slow)\n\n**Examples**:\n‚Ä¢ Array access: O(1)\n‚Ä¢ Linear search: O(n)\n‚Ä¢ Binary search: O(log n)\n‚Ä¢ Bubble sort: O(n¬≤)';
                } else if (msg.includes('recursion') || msg.includes('recursive')) {
                    return 'üîÅ **Recursion**\n\nFunction calling itself.\n\n**Components**:\n1. Base case (stopping condition)\n2. Recursive case (calls itself)\n\n**Example - Factorial**:\nint factorial(int n) {\n    if (n <= 1) return 1;  // base case\n    return n * factorial(n-1);  // recursive\n}\n\n**Pros**: Elegant, natural for some problems\n**Cons**: Memory overhead, can be slow\n\nüí° Every recursion can be converted to iteration!';
                } else {
                    return `Great question about Computer Science! üíª\n\nI can help with:\n‚Ä¢ Programming Fundamentals (Variables, Data Types)\n‚Ä¢ Control Structures (If-else, Loops)\n‚Ä¢ Functions & Methods\n‚Ä¢ Arrays & Data Structures\n‚Ä¢ Algorithms & Complexity (Big O)\n‚Ä¢ Recursion\n‚Ä¢ Object-Oriented Programming\n‚Ä¢ Computer Systems (CPU, Memory, Storage)\n\nWhat topic interests you? üí°`;
                }
            }
            
            // Business Studies responses
            else if (subject === 'Business Studies') {
                if (msg.includes('swot')) {
                    return 'üìä **SWOT Analysis**\n\nFramework to analyze a business:\n\n**Strengths** (Internal, Positive):\n‚Ä¢ What company does well\n‚Ä¢ Competitive advantages\n‚Ä¢ Resources\n\n**Weaknesses** (Internal, Negative):\n‚Ä¢ Areas needing improvement\n‚Ä¢ Resource limitations\n\n**Opportunities** (External, Positive):\n‚Ä¢ Market trends\n‚Ä¢ Technological changes\n‚Ä¢ Competitor weaknesses\n\n**Threats** (External, Negative):\n‚Ä¢ Competition\n‚Ä¢ Economic changes\n‚Ä¢ Regulations\n\nüí° Use SWOT to inform strategic planning!';
                } else if (msg.includes('marketing') || msg.includes('4 p') || msg.includes('marketing mix')) {
                    return 'üéØ **Marketing Mix (4 Ps)**\n\n**Product**: What you sell (features, quality, design)\n**Price**: How much (pricing strategy, discounts)\n**Place**: Where sold (distribution channels, location)\n**Promotion**: How you advertise (advertising, PR, sales)\n\n**Extended (7 Ps) adds**:\n‚Ä¢ **People**: Staff, customers\n‚Ä¢ **Process**: Service delivery\n‚Ä¢ **Physical Evidence**: Tangible elements\n\n**Modern (4 Cs)**:\n‚Ä¢ Customer Value, Cost, Convenience, Communication';
                } else if (msg.includes('leadership') || msg.includes('leader')) {
                    return 'üëî **Leadership**\n\n**Definition**: Ability to influence others to achieve goals\n\n**Leadership Styles**:\n‚Ä¢ **Autocratic**: Leader makes all decisions\n‚Ä¢ **Democratic**: Participative, consults team\n‚Ä¢ **Laissez-faire**: Hands-off, minimal guidance\n‚Ä¢ **Transformational**: Inspires change\n‚Ä¢ **Transactional**: Reward/punishment based\n\n**Qualities**:\n‚Ä¢ Vision\n‚Ä¢ Communication\n‚Ä¢ Integrity\n‚Ä¢ Decision-making\n‚Ä¢ Motivation\n\nüí° Leadership ‚â† Management (leadership is influence, management is control)';
                } else if (msg.includes('break even') || msg.includes('break-even')) {
                    return 'üìä **Break-Even Analysis**\n\n**Break-Even Point**: Where Total Revenue = Total Costs (zero profit)\n\n**Formula**:\nBreak-Even Quantity = Fixed Costs / (Selling Price - Variable Cost per unit)\n\n**Graph**:\n‚Ä¢ X-axis: Quantity\n‚Ä¢ Y-axis: Revenue/Cost\n‚Ä¢ Break-even: Where lines intersect\n\n**Uses**:\n‚Ä¢ Pricing decisions\n‚Ä¢ Cost control\n‚Ä¢ Profit planning\n\n**Margin of Safety**: Actual sales - Break-even sales';
                } else if (msg.includes('human resource') || msg.includes('hr') || msg.includes('recruitment')) {
                    return 'üë• **Human Resource Management**\n\n**Functions**:\n‚Ä¢ **Recruitment**: Finding candidates\n‚Ä¢ **Selection**: Choosing best candidates\n‚Ä¢ **Training**: Developing skills\n‚Ä¢ **Performance Appraisal**: Evaluating work\n‚Ä¢ **Compensation**: Pay & benefits\n‚Ä¢ **Employee Relations**: Managing workplace\n\n**Recruitment Methods**:\n‚Ä¢ Internal (promotions, transfers)\n‚Ä¢ External (advertising, agencies)\n\n**Selection Process**:\n1. Application\n2. Interview\n3. Testing\n4. Reference checks\n5. Offer';
                } else if (msg.includes('cash flow') || msg.includes('cashflow')) {
                    return 'üí∞ **Cash Flow**\n\n**Definition**: Movement of money in and out of business\n\n**Cash Flow Statement**:\n‚Ä¢ **Operating Activities**: Day-to-day business\n‚Ä¢ **Investing Activities**: Buying/selling assets\n‚Ä¢ **Financing Activities**: Loans, equity\n\n**Cash Inflows**:\n‚Ä¢ Sales revenue\n‚Ä¢ Loans received\n‚Ä¢ Asset sales\n\n**Cash Outflows**:\n‚Ä¢ Expenses\n‚Ä¢ Loan repayments\n‚Ä¢ Asset purchases\n\n**Importance**:\n‚Ä¢ Solvency (ability to pay debts)\n‚Ä¢ Business survival\n‚Ä¢ Investment decisions';
                } else if (msg.includes('business plan') || msg.includes('planning')) {
                    return 'üìã **Business Planning**\n\n**Components**:\n1. **Executive Summary**: Overview\n2. **Business Description**: What you do\n3. **Market Analysis**: Industry, competitors\n4. **Marketing Strategy**: How to attract customers\n5. **Operations Plan**: How business runs\n6. **Financial Plan**: Projections, funding\n7. **Management Team**: Key people\n\n**Purpose**:\n‚Ä¢ Guide operations\n‚Ä¢ Attract investors\n‚Ä¢ Secure loans\n‚Ä¢ Set goals\n\nüí° A good plan is flexible and realistic!';
                } else if (msg.includes('sole proprietorship') || msg.includes('partnership') || msg.includes('corporation') || msg.includes('company type')) {
                    return 'üè¢ **Business Ownership Types**\n\n**Sole Proprietorship**:\n‚Ä¢ One owner\n‚Ä¢ Easy to start\n‚Ä¢ Unlimited liability\n‚Ä¢ All profits to owner\n\n**Partnership**:\n‚Ä¢ 2+ owners\n‚Ä¢ Shared profits/losses\n‚Ä¢ Unlimited liability (general)\n‚Ä¢ Easy to form\n\n**Corporation/Company**:\n‚Ä¢ Separate legal entity\n‚Ä¢ Limited liability\n‚Ä¢ Can raise capital easily\n‚Ä¢ More complex to set up\n\n**Franchise**:\n‚Ä¢ Use established brand\n‚Ä¢ Pay fees/royalties\n‚Ä¢ Proven business model';
                } else if (msg.includes('management') || msg.includes('manager')) {
                    return 'üìä **Management Functions**\n\n**4 Main Functions** (Fayol):\n1. **Planning**: Setting goals, strategies\n2. **Organizing**: Structuring resources\n3. **Leading**: Motivating, directing\n4. **Controlling**: Monitoring, correcting\n\n**Management Levels**:\n‚Ä¢ **Top**: Strategic decisions\n‚Ä¢ **Middle**: Tactical planning\n‚Ä¢ **First-line**: Operational supervision\n\n**Skills Needed**:\n‚Ä¢ Technical (job-specific)\n‚Ä¢ Human (people skills)\n‚Ä¢ Conceptual (big picture)';
                } else {
                    return `Great question about Business Studies! üè¢\n\nI can help with:\n‚Ä¢ Business Ownership Types (Sole proprietorship, Partnership, Corporation)\n‚Ä¢ Management & Leadership Styles\n‚Ä¢ Marketing (4 Ps, SWOT Analysis, Market Segmentation)\n‚Ä¢ Human Resource Management\n‚Ä¢ Financial Management (Cash Flow, Break-Even Analysis)\n‚Ä¢ Business Planning\n‚Ä¢ Operations Management\n‚Ä¢ Entrepreneurship\n\nWhat would you like to explore? üí°`;
                }
            }
            
            // Default response
            else {
                return `Great question about ${subject}! üìö\n\nI'm here to help you learn. Could you be more specific about what you'd like to understand? You can ask about:\n‚Ä¢ Key concepts and definitions\n‚Ä¢ Step-by-step explanations\n‚Ä¢ Examples and practice problems\n‚Ä¢ Exam preparation tips\n\nWhat topic should we focus on? üí°`;
            }
        }

        function addMessage(text, sender, typingId = null) {
            const chat = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${sender}-msg`;
            div.innerHTML = text.replace(/\n/g, '<br>');
            if (typingId) {
                div.setAttribute('data-typing-id', typingId);
            }
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        // Homework Analysis - Text Input
        // Homework submission functions
        let homeworkFiles = [];
        
        // Handle file selection
        document.addEventListener('DOMContentLoaded', function() {
            const homeworkFileInput = document.getElementById('homeworkFile');
            if (homeworkFileInput) {
                homeworkFileInput.addEventListener('change', function(e) {
                    homeworkFiles = Array.from(e.target.files);
                    const submitBtn = document.getElementById('submitHomeworkBtn');
                    if (homeworkFiles.length > 0) {
                        submitBtn.style.display = 'inline-block';
                    } else {
                        submitBtn.style.display = 'none';
                    }
                });
                
                // Drag and drop
                const uploadArea = document.getElementById('uploadArea');
                if (uploadArea) {
                    uploadArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        uploadArea.classList.add('dragover');
                    });
                    
                    uploadArea.addEventListener('dragleave', () => {
                        uploadArea.classList.remove('dragover');
                    });
                    
                    uploadArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        uploadArea.classList.remove('dragover');
                        const files = Array.from(e.dataTransfer.files);
                        homeworkFiles = files;
                        homeworkFileInput.files = e.dataTransfer.files;
                        const submitBtn = document.getElementById('submitHomeworkBtn');
                        if (homeworkFiles.length > 0) {
                            submitBtn.style.display = 'inline-block';
                            // Show file name in upload area
                            const fileNames = homeworkFiles.map(f => f.name).join(', ');
                            uploadArea.innerHTML = `
                                <div style="font-size: 16px; margin-bottom: 4px; color: #22c55e;">‚úì</div>
                                <p style="font-size: 12px; color: #22c55e; font-weight: bold; margin: 4px 0;">${fileNames} uploaded!</p>
                                <p style="font-size: 10px; color: #666;">Click "Submit Homework" to complete submission</p>
                            `;
                            // Make it clickable again to change file
                            uploadArea.onclick = () => document.getElementById('homeworkFile').click();
                        }
                    });
                    
                    // Make upload area clickable
                    uploadArea.onclick = () => document.getElementById('homeworkFile').click();
                }
            }
            
            // Load homework submissions on page load
            displayHomeworkSubmissions();
        });
        
        async function submitHomework() {
            if (homeworkFiles.length === 0) {
                alert('Please select a file to submit!');
                return;
            }
            
            if (!currentSubject) {
                alert('Please select a subject first!');
                return;
            }
            
            // Show loading
            document.getElementById('homework-loading').style.display = 'block';
            const submitBtn = document.getElementById('submitHomeworkBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            try {
                const formData = new FormData();
                formData.append('subject', currentSubject);
                homeworkFiles.forEach((file, index) => {
                    formData.append('files', file);
                });
                
                const response = await fetch('http://localhost:5050/api/homework/submit', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Save to localStorage
                const submissions = JSON.parse(localStorage.getItem('homeworkSubmissions') || '[]');
                const newSubmission = {
                    id: data.homework_id || `hw_${Date.now()}`,
                    homework_number: submissions.filter(s => s.subject === currentSubject).length + 1,
                    subject: currentSubject,
                    submitted_date: new Date().toISOString(),
                    status: 'uploaded',
                    file_name: data.file_name || homeworkFiles[0].name,
                    file_url: data.file_url || ''
                };
                submissions.push(newSubmission);
                localStorage.setItem('homeworkSubmissions', JSON.stringify(submissions));
                
                // Update progress tracking (just track submission, no marks)
                const progressData = JSON.parse(localStorage.getItem('studentPerformance') || '{}');
                if (!progressData.homework) progressData.homework = {};
                if (!progressData.homework[currentSubject]) progressData.homework[currentSubject] = [];
                progressData.homework[currentSubject].push({
                    date: newSubmission.submitted_date,
                    submitted: true
                });
                localStorage.setItem('studentPerformance', JSON.stringify(progressData));
                
                // Reset form
                homeworkFiles = [];
                document.getElementById('homeworkFile').value = '';
                submitBtn.style.display = 'none';
                // Reset upload area display
                const uploadArea = document.getElementById('uploadArea');
                if (uploadArea) {
                    uploadArea.innerHTML = `
                        <div style="font-size: 18px; margin-bottom: 4px; opacity: 0.7;">üìé üì∑ üìÑ</div>
                        <p style="font-size: 12px; color: #ff4500; font-weight: bold; margin: 4px 0;">Click to upload or drag & drop your file here</p>
                        <p style="font-size: 10px; color: #666;">Supported: PDF, Word, Images</p>
                    `;
                    uploadArea.onclick = () => document.getElementById('homeworkFile').click();
                }
                
                // Refresh display
                displayHomeworkSubmissions();
                
                alert(`‚úÖ Homework uploaded successfully!\n\nFile: ${newSubmission.file_name}\nSubject: ${currentSubject}\nStatus: Uploaded`);
                
            } catch (error) {
                console.error('Error:', error);
                alert('‚ö†Ô∏è Error submitting homework. Please try again or check if the backend is running.');
            } finally {
                document.getElementById('homework-loading').style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = '‚úÖ Submit Homework';
            }
        }
        
        function displayHomeworkSubmissions() {
            const submissions = JSON.parse(localStorage.getItem('homeworkSubmissions') || '[]');
            const tbody = document.getElementById('homeworkSubmissionsBody');
            
            if (!tbody) return;
            
            // Filter by current subject
            const subjectSubmissions = currentSubject 
                ? submissions.filter(s => s.subject === currentSubject)
                : submissions;
            
            if (subjectSubmissions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="padding: 40px; text-align: center; color: #999; font-style: italic;">
                            No homework submissions yet. Upload your first homework above!
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = subjectSubmissions.map((sub, index) => {
                const date = new Date(sub.submitted_date);
                const formattedDate = date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                return `
                    <tr class="homework-row">
                        <td style="font-weight: 600; color: #667eea;">Homework ${sub.homework_number || index + 1}</td>
                        <td>${sub.subject}</td>
                        <td>${formattedDate}</td>
                        <td style="text-align: center;">
                            <span class="homework-status ${sub.status || 'uploaded'}" style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #dcfce7; color: #166534;">
                                ‚úì Uploaded
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <div class="homework-actions">
                                <button class="homework-action-btn view" onclick="viewHomework('${sub.id}')" title="View homework">üëÅÔ∏è View</button>
                                <button class="homework-action-btn download" onclick="downloadHomework('${sub.id}')" title="Download homework">‚¨áÔ∏è Download</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function viewHomework(homeworkId) {
            const submissions = JSON.parse(localStorage.getItem('homeworkSubmissions') || '[]');
            const submission = submissions.find(s => s.id === homeworkId);
            
            if (!submission) {
                alert('Homework not found!');
                return;
            }
            
            // Create modal to view homework
            const modal = document.createElement('div');
            modal.className = 'corrections-modal show';
            modal.innerHTML = `
                <div class="corrections-content">
                    <h3 style="margin-top: 0; color: #667eea;">Homework ${submission.homework_number || 'N/A'} - ${submission.subject}</h3>
                    <p><strong>Submitted:</strong> ${new Date(submission.submitted_date).toLocaleString()}</p>
                    <p><strong>Status:</strong> <span class="homework-status ${submission.status || 'uploaded'}" style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #dcfce7; color: #166534;">‚úì Uploaded</span></p>
                    <p><strong>File:</strong> ${submission.file_name || 'N/A'}</p>
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button onclick="downloadHomework('${homeworkId}')" style="padding: 10px 20px; background: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer;">‚¨áÔ∏è Download</button>
                        <button onclick="this.closest('.corrections-modal').remove()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function downloadHomework(homeworkId) {
            const submissions = JSON.parse(localStorage.getItem('homeworkSubmissions') || '[]');
            const submission = submissions.find(s => s.id === homeworkId);
            
            if (!submission) {
                alert('Homework not found!');
                return;
            }
            
            // If file_url exists, download from backend
            if (submission.file_url) {
                window.open(submission.file_url, '_blank');
            } else {
                alert('File not available for download. The file may have been processed and stored on the server.');
            }
        }
        
        function showCorrections(homeworkId) {
            const submissions = JSON.parse(localStorage.getItem('homeworkSubmissions') || '[]');
            const submission = submissions.find(s => s.id === homeworkId);
            
            if (!submission || !submission.corrections || submission.corrections.length === 0) {
                alert('No corrections available for this homework.');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'corrections-modal show';
            modal.innerHTML = `
                <div class="corrections-content">
                    <h3 style="margin-top: 0; color: #f59e0b;">üìù Corrections Needed - Homework ${submission.homework_number || 'N/A'}</h3>
                    <div style="margin-top: 20px;">
                        ${submission.corrections.map((correction, index) => `
                            <div style="margin-bottom: 15px; padding: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px;">
                                <strong>Issue ${index + 1}:</strong> ${correction}
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="this.closest('.corrections-modal').remove()" style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function displayHomeworkResults(data) {
            const contentDiv = document.getElementById('homework-content');
            let html = '';
            
            // Parse multiple solutions from the answer text
            const answerText = data.answer;
            
            // Try to extract multiple solutions
            const solutionPatterns = [
                /Solution\s+1[:\-]?\s*(.*?)(?=Solution\s+2|Common\s+Mistakes|Suggestions|Comparison|$)/is,
                /Solution\s+2[:\-]?\s*(.*?)(?=Solution\s+3|Common\s+Mistakes|Suggestions|Comparison|$)/is,
                /Solution\s+3[:\-]?\s*(.*?)(?=Solution\s+4|Common\s+Mistakes|Suggestions|Comparison|$)/is,
                /Solution\s+4[:\-]?\s*(.*?)(?=Solution\s+5|Common\s+Mistakes|Suggestions|Comparison|$)/is,
                /Solution\s+5[:\-]?\s*(.*?)(?=Common\s+Mistakes|Suggestions|Comparison|$)/is
            ];
            
            const solutions = [];
            solutionPatterns.forEach((pattern, index) => {
                const match = answerText.match(pattern);
                if (match && match[1]) {
                    solutions.push(match[1].trim());
                }
            });
            
            // If no structured solutions found, check for numbered/bulleted solutions
            if (solutions.length === 0) {
                const altPatterns = [
                    /(?:Approach\s+1|Method\s+1|1[\.\)]\s*)(.*?)(?=Approach\s+2|Method\s+2|2[\.\)]\s*|Common|Suggestions|$)/is,
                    /(?:Approach\s+2|Method\s+2|2[\.\)]\s*)(.*?)(?=Approach\s+3|Method\s+3|3[\.\)]\s*|Common|Suggestions|$)/is,
                    /(?:Approach\s+3|Method\s+3|3[\.\)]\s*)(.*?)(?=Approach\s+4|Method\s+4|4[\.\)]\s*|Common|Suggestions|$)/is
                ];
                altPatterns.forEach((pattern, index) => {
                    const match = answerText.match(pattern);
                    if (match && match[1]) {
                        solutions.push(match[1].trim());
                    }
                });
            }
            
            // Display Multiple Solutions with colorful boxes
            if (solutions.length > 0) {
                html += `<div style="margin-bottom: 25px;">
                    <h4 style="color: #667eea; font-size: 22px; margin-bottom: 15px;">
                        <span class="academic-icon">üéØ</span> Multiple Solutions Generated (${solutions.length})
                    </h4>`;
                
                solutions.forEach((solution, index) => {
                    const solutionClass = `solution-${Math.min(index + 1, 5)}`;
                    const icons = ['üßÆ', 'üí°', 'üìê', 'üî¨', 'üéì'];
                    html += `<div class="solution-box ${solutionClass}">
                        <h5 style="color: ${['#ff9800', '#2196f3', '#9c27b0', '#4caf50', '#f44336'][Math.min(index, 4)]}; font-size: 18px; margin-bottom: 10px;">
                            ${icons[Math.min(index, 4)]} <strong>Solution ${index + 1}</strong>
                        </h5>
                        <div style="white-space: pre-wrap; line-height: 1.8; color: #333;">${solution.replace(/\n/g, '<br>')}</div>
                    </div>`;
                });
                
                html += `</div>`;
            } else {
                // If no structured solutions, display the full answer with formatting
                html += `<div class="solution-box solution-1">
                    <h4 style="color: #ff9800; font-size: 20px; margin-bottom: 15px;">
                        <span class="academic-icon">üí°</span> AI-Generated Solutions & Answer
                    </h4>
                    <div style="white-space: pre-wrap; line-height: 1.8; color: #333; font-size: 15px;">${answerText.replace(/\n/g, '<br>')}</div>
                </div>`;
            }
            
            // Comparison Section (if exists)
            if (answerText.includes('Comparison') || answerText.includes('comparison')) {
                const comparisonMatch = answerText.match(/(?:Comparison|comparison).*?:(.*?)(?=Common|Suggestions|$)/is);
                if (comparisonMatch) {
                    html += `<div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 12px; border-left: 5px solid #ff9800;">
                        <h4 style="color: #e65100; margin-bottom: 10px; font-size: 18px;">
                            <span class="academic-icon">‚öñÔ∏è</span> Comparison of Methods
                        </h4>
                        <div style="white-space: pre-wrap; line-height: 1.6;">${comparisonMatch[1].trim().replace(/\n/g, '<br>')}</div>
                    </div>`;
                }
            }
            
            // Mistakes Section
            if (data.mistakes && data.mistakes.length > 0) {
                html += `<div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 12px; border-left: 5px solid #ff9800;">
                    <h4 style="color: #e65100; margin-bottom: 15px; font-size: 18px;">
                        <span class="academic-icon">‚ö†Ô∏è</span> Common Mistakes to Avoid
                    </h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">`;
                data.mistakes.forEach(mistake => {
                    html += `<li style="margin-bottom: 10px; font-size: 15px;">${mistake}</li>`;
                });
                html += `</ul></div>`;
            }
            
            // Suggestions Section
            if (data.suggestions && data.suggestions.length > 0) {
                html += `<div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-radius: 12px; border-left: 5px solid #9c27b0;">
                    <h4 style="color: #6a1b9a; margin-bottom: 15px; font-size: 18px;">
                        <span class="academic-icon">üí°</span> Helpful Suggestions & Tips
                    </h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">`;
                data.suggestions.forEach(suggestion => {
                    html += `<li style="margin-bottom: 10px; font-size: 15px;">${suggestion}</li>`;
                });
                html += `</ul></div>`;
            }
            
            // Status/Score
            if (data.score) {
                html += `<div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 10px; border-left: 4px solid #4caf50; text-align: center;">
                    <strong style="color: #2e7d32; font-size: 16px;">
                        <span class="academic-icon">‚úÖ</span> ${data.score}
                    </strong>
                </div>`;
            }
            
            contentDiv.innerHTML = html;
            document.getElementById('homework-result').style.display = 'block';
            
            // Scroll to results
            document.getElementById('homework-result').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Homework File Upload with AI Analysis
        document.getElementById('homeworkFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Show loading
            document.getElementById('uploadArea').innerHTML = `‚úÖ ${file.name} uploaded! AI is analyzing...`;
            document.getElementById('homework-loading').style.display = 'block';
            document.getElementById('homework-result').style.display = 'none';
            
            try {
                // Read file content based on type
                let questionText = '';
                
                if (file.type.startsWith('image/')) {
                    // For images, we'll need OCR or user to describe
                    questionText = `Please analyze this ${file.name} image. The user uploaded a homework question image.`;
                } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                    questionText = await file.text();
                } else if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
                    // PDF would need backend processing, for now prompt user
                    questionText = `PDF file uploaded: ${file.name}. Please extract and analyze the questions from this PDF.`;
                } else {
                    questionText = `File uploaded: ${file.name}. Please analyze the questions in this file.`;
                }
                
                // Use current subject or prompt user
                if (!currentSubject) {
                    const proceed = confirm('No subject selected. Analysis will default to Mathematics. Would you like to select a subject first for better results?');
                    if (!proceed) {
                        document.getElementById('homework-loading').style.display = 'none';
                        document.getElementById('uploadArea').innerHTML = `
                            <div style="font-size: 48px; margin-bottom: 15px;">
                                <span class="academic-icon">üìé</span>
                                <span class="academic-icon">üì∑</span>
                                <span class="academic-icon">üìë</span>
                            </div>
                            <p style="font-size: 18px; color: #ff4500; font-weight: bold; margin: 10px 0;">Click to upload or drag & drop your file here</p>
                            <p style="font-size: 14px; color: #666;">Supported: PDF, Word, Images, Text files</p>
                        `;
                        return;
                    }
                }
                const subject = currentSubject || 'Mathematics';
                
                // Send to AI for analysis
                const response = await fetch('http://localhost:5050/api/homework/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subject: subject,
                        question_text: questionText,
                        question_type: 'file',
                        file_name: file.name
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displayHomeworkResults(data);
                
                // Track homework submission from file
                saveHomeworkResult(
                    subject,
                    file.name + ': ' + questionText.substring(0, 80),
                    true, // success - AI generated solution
                    data.answer,
                    new Date().toISOString()
                );
                
                document.getElementById('uploadArea').innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 15px;">
                        <span class="academic-icon">üìé</span>
                        <span class="academic-icon">üì∑</span>
                        <span class="academic-icon">üìë</span>
                    </div>
                    <p style="font-size: 18px; color: #ff4500; font-weight: bold; margin: 10px 0;">Click to upload or drag & drop your file here</p>
                    <p style="font-size: 14px; color: #666;">Supported: PDF, Word, Images, Text files</p>
                `;
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('homework-loading').style.display = 'none';
                document.getElementById('uploadArea').innerHTML = 'üì§ Upload another homework';
                document.getElementById('homework-result').style.display = 'block';
                document.getElementById('homework-content').innerHTML = 
                    '<p style="color: red;">‚ö†Ô∏è Error analyzing file. For best results, please type your question in the text box above, or ensure the backend is running.</p>';
            } finally {
                document.getElementById('homework-loading').style.display = 'none';
            }
        });

        // Drag & Drop
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const fileInput = document.getElementById('homeworkFile');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(files[0]);
                fileInput.files = dataTransfer.files;
                fileInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });

        // ===== QUIZ ENGINE (1 question per page, min 20 per set) =====
        let quizQuestions = [];
        let quizIndex = 0;
        let quizAnswers = {}; // {index: selectedOptionIndex}
        let quizTotal = 20;
        let currentSet = 1;
        let totalSets = 5; // Can be updated dynamically
        let questionBank = {}; // {setNumber: [questions]}

        function subjectTheme(subject) {
            // Display just "Mathematics" for Mathematics, exact name for others
            const badge = document.getElementById('quizSubjectBadge');
            const title = document.getElementById('quizTitle');
            const displaySubject = subject || 'Mathematics';
            badge.textContent = displaySubject === 'Mathematics' ? 'Mathematics' : displaySubject;
            title.textContent = `${displaySubject} Quiz Challenge`;
        }

        function setQuizUIState(state) {
            // state: "idle" | "inprogress" | "result"
            const quizBody = document.getElementById('quizBody');
            const quizResult = document.getElementById('quizResult');
            if (quizBody) quizBody.style.display = (state === "result") ? "none" : "block";
            if (quizResult) quizResult.style.display = (state === "result") ? "block" : "none";
        }

        function updateProgressUI() {
            const total = quizQuestions.length || quizTotal;
            const current = Math.min(quizIndex + 1, total);
            const totalCountEl = document.getElementById('quizTotalCount');
            const progressTextEl = document.getElementById('quizProgressText');
            const progressBarEl = document.getElementById('quizProgressBar');
            
            if (totalCountEl) totalCountEl.textContent = total;
            if (progressTextEl) progressTextEl.textContent = `Set ${currentSet}: ${current} / ${total}`;
            const pct = total ? Math.round((current / total) * 100) : 0;
            if (progressBarEl) progressBarEl.style.width = `${pct}%`;

            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');
            const btnFinish = document.getElementById('btnFinish');
            
            if (btnPrev) btnPrev.disabled = quizIndex <= 0;
            const isLast = quizIndex >= total - 1;

            if (btnNext) btnNext.style.display = isLast ? "none" : "inline-block";
            if (btnFinish) btnFinish.style.display = isLast ? "inline-block" : "none";

            const chosen = quizAnswers[quizIndex];
            if (btnNext) btnNext.disabled = (chosen === undefined);
            if (btnFinish) btnFinish.disabled = (chosen === undefined);
        }

        function renderQuestion() {
            const quizQuestionTitle = document.getElementById('quizQuestionTitle');
            const quizOptions = document.getElementById('quizOptions');
            
            if (!quizQuestions.length) {
                if (quizQuestionTitle) quizQuestionTitle.textContent = 'Click "Generate New Quiz" to start.';
                if (quizOptions) quizOptions.innerHTML = '';
                const btnPrev = document.getElementById('btnPrev');
                const btnNext = document.getElementById('btnNext');
                const btnFinish = document.getElementById('btnFinish');
                if (btnPrev) btnPrev.disabled = true;
                if (btnNext) btnNext.disabled = true;
                if (btnFinish) btnFinish.disabled = true;
                return;
            }

            const q = quizQuestions[quizIndex];
            const difficultyPill = document.getElementById('quizDifficultyPill');
            const topicPill = document.getElementById('quizTopicPill');
            
            if (difficultyPill) difficultyPill.textContent = q.difficulty || 'Adaptive';
            if (topicPill) topicPill.textContent = `Topic: ${q.topic || 'Auto'}`;
            if (quizQuestionTitle) quizQuestionTitle.textContent = `Q${quizIndex + 1}. ${q.question}`;

            if (quizOptions) {
                quizOptions.innerHTML = '';

                q.options.forEach((opt, i) => {
                    const div = document.createElement('div');
                    div.className = 'option';
                    div.innerHTML = `<b>${String.fromCharCode(65+i)}.</b> ${opt}`;
                    div.onclick = () => selectOption(i);
                    if (quizAnswers[quizIndex] === i) div.classList.add('selected');
                    quizOptions.appendChild(div);
                });
            }

            updateProgressUI();
        }

        function selectOption(i) {
            quizAnswers[quizIndex] = i;
            // update selection styles
            const options = document.querySelectorAll('#quizOptions .option');
            options.forEach((el, idx) => {
                el.classList.toggle('selected', idx === i);
            });
            updateProgressUI();
        }

        function nextQuestion() {
            if (quizIndex < quizQuestions.length - 1) {
                quizIndex++;
                renderQuestion();
            }
        }

        function prevQuestion() {
            if (quizIndex > 0) {
                quizIndex--;
                renderQuestion();
            }
        }

        function calculateScore() {
            let score = 0;
            quizQuestions.forEach((q, idx) => {
                if (quizAnswers[idx] === q.correctIndex) score++;
            });
            return score;
        }

        function finishQuiz() {
            const score = calculateScore();
            const total = quizQuestions.length;
            const subject = currentSubject || 'Mathematics';

            setQuizUIState("result");
            const totalMarkEl = document.getElementById('totalMarkEarned');
            const resultSubtextEl = document.getElementById('resultSubtext');
            
            if (totalMarkEl) totalMarkEl.textContent = `${score}/${total} (Set ${currentSet})`;

            let msg = `Set ${currentSet} completed! `;
            const pct = total > 0 ? (score / total) * 100 : 0;
            if (pct >= 80) msg += "Excellent performance ‚Äî keep it up!";
            else if (pct >= 50) msg += "Nice work ‚Äî a little more practice will boost your score.";
            else msg += "Good effort. Review your weak areas and try again to improve.";
            
            if (currentSet < totalSets) {
                msg += ` You can continue to Set ${currentSet + 1} or try another quiz.`;
            }
            
            if (resultSubtextEl) resultSubtextEl.textContent = msg;
            
            // Track wrong answers with topics
            const wrongAnswers = [];
            quizQuestions.forEach((q, idx) => {
                if (quizAnswers[idx] !== q.correctIndex) {
                    wrongAnswers.push({
                        question: q.question,
                        topic: q.topic || extractTopicFromQuestion(q.question),
                        selected: q.options[quizAnswers[idx]] || 'Not answered',
                        correct: q.options[q.correctIndex]
                    });
                }
            });
            
            // Save quiz result
            saveQuizResult(subject, score, total, wrongAnswers, new Date().toISOString(), currentSet);
        }

        async function generateQuiz() {
            const subject = (typeof currentSubject !== "undefined" && currentSubject) ? currentSubject : "Mathematics";
            subjectTheme(subject);

            // Minimum 20 questions
            quizTotal = 20;

            // Build quiz questions
            quizQuestions = buildFallbackQuiz(subject, quizTotal);

            quizIndex = 0;
            quizAnswers = {};
            setQuizUIState("inprogress");
            renderQuestion();
        }

        // Simple fallback generator (replace with AI-generated questions later)
        function buildFallbackQuiz(subject, n) {
            // Minimum 20 questions required for all quizzes
            const minQuestions = Math.max(n || 20, 20);
            
            // Use existing subjectQuizQuestions if available
            const existingQuiz = typeof subjectQuizQuestions !== "undefined" ? subjectQuizQuestions[subject] : null;
            
            if (existingQuiz && existingQuiz.length >= minQuestions) {
                // Use existing questions (at least 20), shuffle for variety
                const converted = existingQuiz.map((q) => ({
                    topic: subject,
                    difficulty: "Adaptive",
                    question: q.q,
                    options: q.options,
                    correctIndex: q.correct
                }));
                
                // Shuffle questions for variety, then take required number
                const shuffled = converted.sort(() => Math.random() - 0.5);
                return shuffled.slice(0, minQuestions);
            } else if (existingQuiz && existingQuiz.length > 0) {
                // Convert existing questions and reuse them to reach minimum 20
                const converted = existingQuiz.map((q) => ({
                    topic: subject,
                    difficulty: "Adaptive",
                    question: q.q,
                    options: q.options,
                    correctIndex: q.correct
                }));
                
                // If we have questions but not enough, cycle through them to reach minimum
                let index = 0;
                while (converted.length < minQuestions) {
                    const originalQ = existingQuiz[index % existingQuiz.length];
                    converted.push({
                        topic: subject,
                        difficulty: "Adaptive",
                        question: originalQ.q,
                        options: [...originalQ.options], // Copy options
                        correctIndex: originalQ.correct
                    });
                    index++;
                }
                
                // Shuffle for variety
                const shuffled = converted.sort(() => Math.random() - 0.5);
                return shuffled.slice(0, minQuestions);
            }
            
            // Generic fallback - create minimum 20 questions (should not happen with expanded question banks)
            const bank = [];
            for (let i = 1; i <= minQuestions; i++) {
                bank.push({
                    topic: subject,
                    difficulty: "Adaptive",
                    question: `${subject}: Question ${i} ‚Äî Choose the correct answer.`,
                    options: ["Option A", "Option B", "Option C", "Option D"],
                    correctIndex: (i - 1) % 4 // rotates 0..3
                });
            }
            return bank;
        }

        // Call this when user switches subject or opens Quiz tab
        function initQuizUI() {
            const subject = (typeof currentSubject !== "undefined" && currentSubject) ? currentSubject : "Mathematics";
            subjectTheme(subject);
            setQuizUIState("idle");
            renderQuestion();
        }

        // Initialize quiz UI when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initQuizUI);
        } else {
            initQuizUI();
        }

        // Tab button event listeners
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const section = this.getAttribute('data-section');
                showSection(section, this);
            });
        });

        // Enter to send message
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        // Homework document functions
        async function downloadHomework(assignmentId) {
            const data = JSON.parse(localStorage.getItem('studentPerformance') || '{}');
            const assignment = (data.homeworkAssignments || []).find(a => a.id === assignmentId);
            
            if (!assignment) {
                alert('Assignment not found');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5050/api/homework/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subject: assignment.subject,
                        weak_areas: assignment.weakAreas || [],
                        num_questions: assignment.numQuestions || 5,
                        difficulty: 'medium'
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const filename = assignment.documentUrl || `${assignment.subject}_Homework_${new Date(assignment.assignedDate).toISOString().split('T')[0]}.docx`;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Failed to download homework. Please ensure the backend server is running.');
                }
            } catch (error) {
                console.error('Error downloading homework:', error);
                alert('Error downloading homework. Please check your connection and ensure the backend server is running.');
            }
        }
        
        async function viewHomework(assignmentId) {
            // For now, download the document (can be enhanced to show preview)
            await downloadHomework(assignmentId);
        }
        
        async function regenerateHomeworkDocument(assignmentId) {
            const data = JSON.parse(localStorage.getItem('studentPerformance') || '{}');
            const assignment = (data.homeworkAssignments || []).find(a => a.id === assignmentId);
            
            if (!assignment) {
                alert('Assignment not found');
                return;
            }
            
            // Regenerate and download
            await downloadHomework(assignmentId);
            
            // Update assignment with document info
            assignment.documentUrl = `${assignment.subject}_Homework_${new Date(assignment.assignedDate).toISOString().split('T')[0]}.docx`;
            localStorage.setItem('studentPerformance', JSON.stringify(data));
            updateProgressDisplay(currentProgressSubject || 'all');
        }
        
        // Enter key (Ctrl+Enter) to analyze homework
        const homeworkQuestionEl = document.getElementById('homeworkQuestion');
        if (homeworkQuestionEl) {
            homeworkQuestionEl.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    analyzeHomework();
                }
            });
        }
        
        // Make selectSubject globally accessible immediately
        if (typeof selectSubject === 'function') {
            window.selectSubject = selectSubject;
            console.log('‚úì selectSubject function is available and set as global');
        } else {
            console.error('‚úó selectSubject function is NOT available!');
        }
        
        // Setup subject cards with proper event handlers
        function setupSubjectCards() {
            const subjectCards = document.querySelectorAll('.subject-card');
            console.log('Setting up', subjectCards.length, 'subject cards');
            
            if (subjectCards.length === 0) {
                console.warn('No subject cards found! Retrying in 100ms...');
                setTimeout(setupSubjectCards, 100);
                return;
            }
            
            subjectCards.forEach((card, index) => {
                // Get subject from data attribute (most reliable)
                const subject = card.getAttribute('data-subject');
                
                if (!subject) {
                    console.warn('Card', index, 'has no data-subject attribute');
                    return;
                }
                
                // Make sure cursor shows it's clickable
                card.style.cursor = 'pointer';
                card.style.transition = 'transform 0.2s, box-shadow 0.2s';
                card.setAttribute('role', 'button');
                card.setAttribute('tabindex', '0');
                card.setAttribute('aria-label', `Select ${subject} subject`);
                
                // Add hover effect
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.02)';
                    this.style.boxShadow = '0 8px 16px rgba(0,0,0,0.15)';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1)';
                    this.style.boxShadow = '';
                });
                
                // Create click handler function
                const handleClick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Subject card clicked:', subject, 'Card index:', index);
                    
                    if (subject && typeof selectSubject === 'function') {
                        try {
                            selectSubject(subject);
                        } catch (err) {
                            console.error('Error calling selectSubject:', err);
                            alert('Error selecting subject: ' + err.message);
                        }
                    } else {
                        console.error('Cannot select subject:', subject, 'selectSubject type:', typeof selectSubject);
                        alert('Error: Cannot select subject. Please refresh the page.');
                    }
                };
                
                // Add click event listener
                card.addEventListener('click', handleClick);
                
                // Also support keyboard (Enter/Space)
                card.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        handleClick(e);
                    }
                });
                
                console.log(`‚úì Subject card ${index + 1} setup complete:`, subject);
            });
            
            console.log('‚úì All subject cards setup complete. Total:', subjectCards.length);
        }
        
        // Initialize subject selection system
        function initializeSubjectSelection() {
            // Make sure selectSubject is available
            if (typeof selectSubject !== 'function') {
                console.error('selectSubject function not found! Retrying...');
                setTimeout(initializeSubjectSelection, 100);
                return;
            }
            
            // Make it globally accessible
            window.selectSubject = selectSubject;
            console.log('‚úì selectSubject function is available and globally accessible');
            
            // Setup subject cards
            setupSubjectCards();
        }
        
        // Wait for DOM to be fully loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('‚úì DOM loaded, initializing subject selection...');
                initializeSubjectSelection();
            });
        } else {
            // DOM already loaded, initialize immediately
            console.log('‚úì DOM already loaded, initializing subject selection...');
            initializeSubjectSelection();
        }
        
        // Backup initialization after a short delay
        setTimeout(function() {
            const cards = document.querySelectorAll('.subject-card');
            if (cards.length > 0) {
                // Check if any card has event listeners
                let hasListeners = false;
                for (let i = 0; i < Math.min(cards.length, 1); i++) {
                    // Try to check if listeners exist (not perfect but helps)
                    const subject = cards[i].getAttribute('data-subject');
                    if (subject && typeof window.selectSubject === 'function') {
                        hasListeners = true;
                        break;
                    }
                }
                
                if (!hasListeners && typeof selectSubject === 'function') {
                    console.log('Backup: Retrying subject card setup...');
                    setupSubjectCards();
                }
            }
        }, 1000);
    </script>
</body>
</html>

